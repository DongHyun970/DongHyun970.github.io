<!DOCTYPE html>
<html lang="ko">
<head>
    <title>ë¬¼ë¥˜ ë¡œì¼€ì´ì…˜ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        /* ìŠ¤ìºë„ˆ ì˜ì—­ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        #reader { width: 100%; max-width: 400px; margin: 15px auto; border: 1px solid #ccc; }
        .scanner-controls { text-align: center; margin-bottom: 20px; }
        .scanner-controls button { width: 48%; padding: 10px; }
    </style>
</head>
<body>
    <h1>ğŸ“¦ ë¡œì¼€ì´ì…˜ ì§€ì • / ì¬ê³  ì…ê³ </h1>
    
    <div class="scanner-controls">
        <button onclick="startScanner('barcode')">ìƒí’ˆ ë°”ì½”ë“œ ìŠ¤ìº”</button>
        <button onclick="startScanner('location')">ë¡œì¼€ì´ì…˜ ìŠ¤ìº”</button>
    </div>
    
    <div id="reader"></div> 
    
    <form id="locationForm">
        <label for="barcode">ìƒí’ˆ ë°”ì½”ë“œ:</label>
        <input type="text" id="barcode" placeholder="ìƒí’ˆ ë°”ì½”ë“œë¥¼ ìŠ¤ìº”/ì…ë ¥" required readonly> <label for="batchNo">ë°°ì¹˜ë²ˆí˜¸:</label>
        <input type="text" id="batchNo" placeholder="ë°°ì¹˜ë²ˆí˜¸ë¥¼ ìŠ¤ìº”/ì…ë ¥" required>

        <label for="location">ë™ ë¡œì¼€ì´ì…˜ ë°”ì½”ë“œ:</label>
        <input type="text" id="location" placeholder="ë™ ë¡œì¼€ì´ì…˜ì„ ìŠ¤ìº”/ì…ë ¥" required readonly> <button type="submit">âœ… ë¡œì¼€ì´ì…˜ ì§€ì • ë° ì…ê³ </button>
    </form>
    
    <script>
        // ... (ê¸°ì¡´ GAS_API_URL ë° form event listener ìœ ì§€) ...

        // --- ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ê´€ë ¨ JavaScript ì¶”ê°€ ---
        let html5QrcodeScanner;
        let currentScanTarget = '';

        /** ìŠ¤ìºë„ˆ ì‹œì‘ ë° ë°”ì½”ë“œ ì¸ì‹ ì²˜ë¦¬ */
        function onScanSuccess(decodedText, decodedResult) {
            console.log(`Scan result: ${decodedText}`, decodedResult);
            
            if (currentScanTarget === 'barcode') {
                document.getElementById('barcode').value = decodedText;
            } else if (currentScanTarget === 'location') {
                document.getElementById('location').value = decodedText;
            }
            
            // í•œ ë²ˆ ìŠ¤ìº”í•˜ë©´ ìŠ¤ìºë„ˆ ì •ì§€ ë° ì¬ì„¤ì •
            stopScanner();
        }

        /** ìŠ¤ìºë„ˆ ì‹œì‘ */
        function startScanner(target) {
            currentScanTarget = target;
            
            // ê¸°ì¡´ ìŠ¤ìºë„ˆê°€ ìˆìœ¼ë©´ ë¨¼ì € ë©ˆì¶¥ë‹ˆë‹¤.
            if (html5QrcodeScanner) {
                stopScanner();
            }

            // ìŠ¤ìºë„ˆ ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ë° ì‹œì‘
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start(
                { facingMode: "environment" }, // í›„ë©´ ì¹´ë©”ë¼ ì‚¬ìš© ì‹œë„
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess,
                (errorMessage) => { 
                    // console.log(`Scan error: ${errorMessage}`); 
                }
            ).catch((err) => {
                alert(`ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: ${err}. ëª¨ë°”ì¼ ê¸°ê¸°ì—ì„œ ì‹œë„í•˜ê±°ë‚˜ HTTPS í™˜ê²½ì„ í™•ì¸í•˜ì„¸ìš”.`);
            });
            document.getElementById('reader').style.display = 'block';
        }
        
        /** ìŠ¤ìºë„ˆ ì •ì§€ */
        function stopScanner() {
            if (html5QrcodeScanner && html5QrcodeScanner.is scanning) {
                html5QrcodeScanner.stop().then(() => {
                    document.getElementById('reader').style.display = 'none';
                    html5QrcodeScanner = null;
                }).catch((err) => {
                    console.error("Failed to stop scanning.", err);
                });
            }
        }
        // --- ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ê´€ë ¨ JavaScript ë ---

        // ... (ê¸°ì¡´ form event listener ë) ...
    </script>
</body>
</html>
