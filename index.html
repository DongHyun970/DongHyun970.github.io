<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ ì¬ê³  ë¡œì¼€ì´ì…˜</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ... (ê¸°ì¡´ CSS ì½”ë“œëŠ” ë™ì¼í•˜ê²Œ ìœ ì§€) ... */
        :root {
            --primary-color: #007bff;
            --secondary-color: #28a745;
            --danger-color: #dc3545;
            --info-color: #ffc107;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #343a40;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        body { 
            font-family: 'Roboto', sans-serif; 
            padding: 0; 
            margin: 0; 
            background-color: var(--background-color); 
            color: var(--text-color);
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px;
        }
        h1 { 
            font-size: 24px; 
            text-align: center; 
            color: var(--primary-color); 
            margin-bottom: 20px;
        }
        h2 {
            font-size: 18px;
            color: var(--text-color);
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 5px;
            margin-top: 20px;
        }
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tab-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        .tab-controls button {
            padding: 15px;
            border: none;
            background-color: #e9ecef;
            color: var(--text-color);
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .tab-controls button.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        /* í¼ ìš”ì†Œ */
        input:not([type="radio"]), select, button[type="submit"] { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 12px; 
            box-sizing: border-box; 
            border: 1px solid #ced4da; 
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        /* ì•¡ì…˜ ë²„íŠ¼ ìƒ‰ìƒ */
        .action-button { 
            background-color: var(--secondary-color); 
            color: white; 
        }
        #pickingForm .action-button { 
            background-color: var(--danger-color); 
        }
        #stockUpdateForm .action-button { 
            background-color: var(--info-color); 
            color: var(--text-color);
        }

        /* ë°”ì½”ë“œ ìŠ¤ìº” ë²„íŠ¼ ë””ìì¸ */
        .scanner-controls button {
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 4px;
            margin-bottom: 15px;
            width: 100%;
        }

        /* ë¡œì¼€ì´ì…˜ ì…ë ¥ ê·¸ë£¹ */
        .location-group {
            display: flex;
            gap: 5px;
            margin-bottom: 12px;
        }
        .location-group input, .location-group select {
            flex: 1;
            text-align: center;
        }
        
        #reader { 
            width: 100%; 
            max-width: 400px; 
            margin: 15px auto; 
            border: 1px solid #ccc; 
            border-radius: 8px;
            overflow: hidden;
        }
        /* ë©”ì‹œì§€ */
        .success { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; padding: 10px; border-radius: 4px; margin-top: 15px; }
        .error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; border-radius: 4px; margin-top: 15px; }

        /* ë¹„í™œì„±í™” í•„ë“œ */
        input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ìŠ¤ë§ˆíŠ¸ ì¬ê³  ë¡œì¼€ì´ì…˜ ì‹œìŠ¤í…œ</h1>

        <div class="tab-controls">
            <button id="tabInbound" onclick="switchForm('inbound')" class="active">â¬†ï¸ ì…ê³ </button>
            <button id="tabOutbound" onclick="switchForm('outbound')">â¬‡ï¸ ì¶œê³ </button>
            <button id="tabUpdate" onclick="switchForm('update')">ğŸ”„ ì¬ê³  ìˆ˜ì •/ì´ë™</button>
        </div>

        <div id="scannerSection" class="card">
            <h2>ë°”ì½”ë“œ ìŠ¤ìº”</h2>
            <div class="scanner-controls">
                <button onclick="startScanner()">ğŸ“· ìƒí’ˆ ë°”ì½”ë“œ ìŠ¤ìº” ì‹œì‘</button>
                <button onclick="stopScanner()">ìŠ¤ìºë„ˆ ë„ê¸°</button>
            </div>
            <div id="reader"></div>
        </div>

        <div id="inboundFormContainer" class="card">
            <h2>ì…ê³  ì •ë³´</h2>
            <form id="locationForm">
                
                <div class="form-group">
                    <label>ë™ ë¡œì¼€ì´ì…˜ (A-01-01-01):</label>
                    <div class="location-group">
                        <select id="rackType" required onchange="updateLocationField('inbound')">
                            <option value="">ë™</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                        <input type="number" id="rackCol" placeholder="ì—´ (01)" required min="1" max="99" oninput="updateLocationField('inbound')">
                        <input type="number" id="rackFloor" placeholder="ì¸µ (01)" required min="1" max="99" oninput="updateLocationField('inbound')">
                        <select id="rackSide" required onchange="updateLocationField('inbound')">
                            <option value="">ì¢Œ/ìš°</option>
                            <option value="1">1 (ì¢Œ)</option>
                            <option value="2">2 (ìš°)</option>
                        </select>
                    </div>
                    <input type="text" id="fullLocation" placeholder="A-01-01-01 í˜•ì‹ìœ¼ë¡œ ìë™ ì…ë ¥ë©ë‹ˆë‹¤" required readonly>
                </div>

                <div class="form-group">
                    <label for="barcode">ìƒí’ˆ ë°”ì½”ë“œ:</label>
                    <input type="text" id="barcode" placeholder="ìŠ¤ìº” ë˜ëŠ” ì…ë ¥" required>
                </div>
                
                <div class="form-group">
                    <label for="itemName">ìƒí’ˆëª…:</label>
                    <input type="text" id="itemName" placeholder="ìë™ ê¸°ì… / ì‹ ê·œ ë“±ë¡ ì‹œ ì…ë ¥" required>
                </div>

                <div class="form-group">
                    <label for="itemCode">ìƒí’ˆì½”ë“œ:</label>
                    <input type="text" id="itemCode" placeholder="ìë™ ê¸°ì… / ì‹ ê·œ ë“±ë¡ ì‹œ ì…ë ¥" required>
                </div>

                <div class="form-group">
                    <label for="batchNo">ë°°ì¹˜ë²ˆí˜¸ (ë‚ ì§œ ë“±):</label>
                    <input type="text" id="batchNo" placeholder="ë°°ì¹˜ë²ˆí˜¸ ì…ë ¥/ìŠ¤ìº”" required>
                </div>
                
                <div class="form-group">
                    <label for="quantity">ìˆ˜ëŸ‰ (ì…ê³ ):</label>
                    <input type="number" id="quantity" value="1" min="1" required>
                </div>
                
                <div class="form-group">
                    <label for="responsiblePerson">ë‹´ë‹¹ì:</label>
                    <select id="responsiblePerson" required>
                        <option value="ê¹€ë™í˜„" selected>ê¹€ë™í˜„</option>
                        <option value="ê¹€ë™í˜„2">ê¹€ë™í˜„2</option>
                    </select>
                </div>


                <button type="submit" class="action-button">âœ… ë¡œì¼€ì´ì…˜ ì§€ì • ë° ì…ê³ </button>
            </form>
            <div id="statusMessage"></div>
        </div>

        <div id="outboundFormContainer" class="card" style="display:none;">
            <h2>ì¶œê³  ì •ë³´</h2>
            <form id="pickingForm">
                
                <div class="form-group">
                    <label>ì¶œê³  ë™ ë¡œì¼€ì´ì…˜ (A-01-01-01):</label>
                    <div class="location-group">
                        <select id="p_rackType" required onchange="updateLocationField('outbound')">
                            <option value="">ë™</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                        <input type="number" id="p_rackCol" placeholder="ì—´ (01)" required min="1" max="99" oninput="updateLocationField('outbound')">
                        <input type="number" id="p_rackFloor" placeholder="ì¸µ (01)" required min="1" max="99" oninput="updateLocationField('outbound')">
                        <select id="p_rackSide" required onchange="updateLocationField('outbound')">
                            <option value="">ì¢Œ/ìš°</option>
                            <option value="1">1 (ì¢Œ)</option>
                            <option value="2">2 (ìš°)</option>
                        </select>
                    </div>
                    <input type="text" id="p_fullLocation" placeholder="A-01-01-01 í˜•ì‹ìœ¼ë¡œ ìë™ ì…ë ¥ë©ë‹ˆë‹¤" required readonly>
                </div>
                
                <div class="form-group">
                    <label for="p_barcode">ì¶œê³  ìƒí’ˆ ë°”ì½”ë“œ:</label>
                    <input type="text" id="p_barcode" placeholder="ìŠ¤ìº” ë˜ëŠ” ì…ë ¥" required>
                </div>
                
                <div class="form-group">
                    <label for="p_itemName">ìƒí’ˆëª…:</label>
                    <input type="text" id="p_itemName" placeholder="ìë™ ê¸°ì…" readonly>
                </div>
                
                <div class="form-group">
                    <label for="p_itemCode">ìƒí’ˆì½”ë“œ:</label>
                    <input type="text" id="p_itemCode" placeholder="ìë™ ê¸°ì…" readonly>
                </div>
                
                <div class="form-group">
                    <label for="p_batchNo">ì¶œê³  ë°°ì¹˜ë²ˆí˜¸:</label>
                    <input type="text" id="p_batchNo" placeholder="ì¶œê³  ë°°ì¹˜ë²ˆí˜¸" required>
                </div>
                
                <div class="form-group">
                    <label for="p_quantity">ìˆ˜ëŸ‰ (ì¶œê³ ):</label>
                    <input type="number" id="p_quantity" value="1" min="1" required>
                </div>
                
                <div class="form-group">
                    <label for="p_responsiblePerson">ë‹´ë‹¹ì:</label>
                    <select id="p_responsiblePerson" required>
                        <option value="ê¹€ë™í˜„" selected>ê¹€ë™í˜„</option>
                        <option value="ê¹€ë™í˜„2">ê¹€ë™í˜„2</option>
                    </select>
                </div>

                <button type="submit" class="action-button">ğŸ”´ ì¬ê³  ì¶œê³  ì²˜ë¦¬</button>
            </form>
            <div id="pickingStatusMessage"></div>
        </div>

        <div id="stockUpdateFormContainer" class="card" style="display:none;">
            <h2>ì¬ê³  ìˆ˜ì • (ì‹¤ì‚¬, ì´ë™ í›„ ìˆ˜ëŸ‰ ì¡°ì •)</h2>
            <form id="stockUpdateForm">

                <div class="form-group">
                    <label>ìˆ˜ì • ëŒ€ìƒ ë™ ë¡œì¼€ì´ì…˜ (A-01-01-01):</label>
                    <div class="location-group">
                        <select id="u_rackType" required onchange="updateLocationField('update')">
                            <option value="">ë™</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                        <input type="number" id="u_rackCol" placeholder="ì—´ (01)" required min="1" max="99" oninput="updateLocationField('update')">
                        <input type="number" id="u_rackFloor" placeholder="ì¸µ (01)" required min="1" max="99" oninput="updateLocationField('update')">
                        <select id="u_rackSide" required onchange="updateLocationField('update')">
                            <option value="">ì¢Œ/ìš°</option>
                            <option value="1">1 (ì¢Œ)</option>
                            <option value="2">2 (ìš°)</option>
                        </select>
                    </div>
                    <input type="text" id="u_fullLocation" placeholder="A-01-01-01 í˜•ì‹ìœ¼ë¡œ ìë™ ì…ë ¥ë©ë‹ˆë‹¤" required readonly>
                </div>
                
                <div class="form-group">
                    <label for="u_barcode">ìƒí’ˆ ë°”ì½”ë“œ:</label>
                    <input type="text" id="u_barcode" placeholder="ìŠ¤ìº” ë˜ëŠ” ì…ë ¥" required>
                </div>
                
                <div class="form-group">
                    <label for="u_itemName">ìƒí’ˆëª…:</label>
                    <input type="text" id="u_itemName" placeholder="ìë™ ê¸°ì…" readonly>
                </div>
                
                <div class="form-group">
                    <label for="u_itemCode">ìƒí’ˆì½”ë“œ:</label>
                    <input type="text" id="u_itemCode" placeholder="ìë™ ê¸°ì…" readonly>
                </div>
                
                <div class="form-group">
                    <label for="u_batchNo">ë°°ì¹˜ë²ˆí˜¸:</label>
                    <input type="text" id="u_batchNo" placeholder="ë°°ì¹˜ë²ˆí˜¸" required>
                </div>
                
                <div class="form-group">
                    <label for="u_currentQuantity">**ìµœì¢… ì‹¤ì‚¬ ìˆ˜ëŸ‰**:</label>
                    <input type="number" id="u_currentQuantity" value="0" min="0" required>
                    <small>ì´ ë¡œì¼€ì´ì…˜ì˜ ì¬ê³ ë¥¼ ì…ë ¥ëœ ìˆ˜ëŸ‰ìœ¼ë¡œ **ë®ì–´ì”ë‹ˆë‹¤**.</small>
                </div>
                
                <div class="form-group">
                    <label for="u_responsiblePerson">ë‹´ë‹¹ì:</label>
                    <select id="u_responsiblePerson" required>
                        <option value="ê¹€ë™í˜„" selected>ê¹€ë™í˜„</option>
                        <option value="ê¹€ë™í˜„2">ê¹€ë™í˜„2</option>
                    </select>
                </div>


                <button type="submit" class="action-button">ğŸ”„ ì¬ê³  ìˆ˜ëŸ‰ìœ¼ë¡œ ìˆ˜ì •</button>
            </form>
            <div id="updateStatusMessage"></div>
        </div>
        
        <div class="card">
            <h2>ğŸ“Š ë¬¼í’ˆ ì „ì²´ ì¬ê³  í˜„í™©</h2>
            <p>ì „ì²´ ë¬¼í’ˆ ê´€ë¦¬ëŠ” Google Sheetsë¥¼ **ì§ì ‘ ì—´ì–´** `Inventory_Master` ì‹œíŠ¸ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

    </div>

    <script>
        // â­ï¸ GVIZ/TQ ì¡°íšŒë¥¼ ìœ„í•œ ì„¤ì • (Google Sheets ë¬¸ì„œ IDì™€ ì‹œíŠ¸ GID) â­ï¸
        // ğŸš¨ğŸš¨ğŸš¨ ì´ ê°’ì„ ë°˜ë“œì‹œ ë³¸ì¸ì˜ Google Sheets ì •ë³´ë¡œ ë³€ê²½í•´ì•¼ í•©ë‹ˆë‹¤. ğŸš¨ğŸš¨ğŸš¨
        const SHEET_ID = '1v5ogbr-49ttfBQISH_S5mIdUTthqhytHmfvvr9IsSMo'; // Google Sheets URLì—ì„œ ì¶”ì¶œ
        const MASTER_SHEET_GID = '17496908'; // Inventory_Master ì‹œíŠ¸ì˜ GID. (URLì˜ #gid= ê°’)

        // ì…/ì¶œê³  POST ìš”ì²­ì„ ìœ„í•œ GAS URL 
        // ğŸš¨ğŸš¨ğŸš¨ GAS ì›¹ ì•± ì¬ë°°í¬ í›„ ë°˜ë“œì‹œ ìµœì‹  URLë¡œ ì—…ë°ì´íŠ¸í•´ì•¼ í•©ë‹ˆë‹¤. ğŸš¨ğŸš¨ğŸš¨
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwfqVjuWsarMFfSmH2HPEl7IxonQ4cwDONHuDvljZpK4wBAwNy_IsxgaDilF7nh8peGkQ/exec'; 
        
        // **********************************************
        // 1. ìƒíƒœ ë³€ìˆ˜ ë° ìœ í‹¸ë¦¬í‹°
        // **********************************************

        let html5QrcodeScanner;
        
        const statusMessage = document.getElementById('statusMessage');
        const pickingStatusMessage = document.getElementById('pickingStatusMessage');
        const updateStatusMessage = document.getElementById('updateStatusMessage');
        
        // ìˆ«ìë¥¼ ë‘ ìë¦¬ ë¬¸ìì—´ë¡œ ë³€í™˜ (01, 02 ë“±)
        const padTwoDigits = (num) => String(num).padStart(2, '0');

        // **********************************************
        // 2. ë¡œì¼€ì´ì…˜ í•„ë“œ ê´€ë¦¬ (ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€)
        // **********************************************

        function updateLocationField(formType) {
            let prefix = '';
            if (formType === 'outbound') prefix = 'p_';
            else if (formType === 'update') prefix = 'u_';

            const rackTypeEl = document.getElementById(`${prefix}rackType`);
            const rackColEl = document.getElementById(`${prefix}rackCol`);
            const rackFloorEl = document.getElementById(`${prefix}rackFloor`);
            const rackSideEl = document.getElementById(`${prefix}rackSide`);
            const fullLocationField = document.getElementById(`${prefix}fullLocation`);
            
            if (!rackTypeEl || !rackColEl || !rackFloorEl || !rackSideEl || !fullLocationField) return;

            const rackType = rackTypeEl.value;
            let rackCol = rackColEl.value;
            let rackFloor = rackFloorEl.value;
            let rackSide = rackSideEl.value; 
            
            if (rackCol) rackCol = padTwoDigits(rackCol);
            if (rackFloor) rackFloor = padTwoDigits(rackFloor);
            // rackSideëŠ” 1 ë˜ëŠ” 2ì´ë¯€ë¡œ padTwoDigitsë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            
            const locationCode = (rackCol && rackFloor && rackSide) ? `${rackCol}-${rackFloor}-${rackSide}` : '';
            
            if (rackType && locationCode) {
                fullLocationField.value = `${rackType}-${locationCode}`;
            } else {
                fullLocationField.value = '';
            }
        }

        function attachLocationListeners(formType) {
            let prefix = '';
            if (formType === 'outbound') prefix = 'p_';
            else if (formType === 'update') prefix = 'u_';
            
            const formContainerId = prefix ? `${formType}FormContainer` : 'inboundFormContainer';
            const container = document.getElementById(formContainerId);
            
            if (container) {
                const elements = container.querySelectorAll('.location-group select, .location-group input[type="number"]');
                elements.forEach(element => {
                    element.removeEventListener('change', () => updateLocationField(formType));
                    element.removeEventListener('input', () => updateLocationField(formType));
                    
                    element.addEventListener('change', () => updateLocationField(formType));
                    element.addEventListener('input', () => updateLocationField(formType));
                });
                updateLocationField(formType);
            }
        }

        // **********************************************
        // 3. ìŠ¤ìºë„ˆ ë° ë°”ì½”ë“œ ìë™ ì™„ì„± (ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€)
        // **********************************************

        function onScanSuccess(decodedText) {
            stopScanner();
            
            const activeForm = getActiveFormType();
            
            // 1. ë°”ì½”ë“œ í•„ë“œì— ê°’ ê¸°ì…
            document.getElementById('barcode').value = decodedText;
            document.getElementById('p_barcode').value = decodedText;
            document.getElementById('u_barcode').value = decodedText;
            
            // 2. ìƒí’ˆ ì •ë³´ ìë™ ì™„ì„± ì‹œë„
            fetchProductInfo(decodedText, activeForm); 
            
            // 3. í¬ì»¤ìŠ¤ ì´ë™
            if (activeForm === 'inbound') document.getElementById('itemName').focus();
            else if (activeForm === 'outbound') document.getElementById('p_batchNo').focus();
            else if (activeForm === 'update') document.getElementById('u_batchNo').focus();
        }
        
        function startScanner() {
            stopScanner(); 
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess,
                (errorMessage) => { /* ìŠ¤ìº” ì—ëŸ¬ ë¬´ì‹œ */ }
            ).catch((err) => {
                alert(`ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: ${err}. HTTPS í™˜ê²½ì„ í™•ì¸í•˜ì„¸ìš”.`);
            });
            document.getElementById('reader').style.display = 'block';
            document.getElementById('reader').scrollIntoView({ behavior: 'smooth' });
        }
        
        function stopScanner() {
            if (html5QrcodeScanner && html5QrcodeScanner.isScanning) { 
                html5QrcodeScanner.stop().then(() => {
                    document.getElementById('reader').style.display = 'none';
                    html5QrcodeScanner = null;
                }).catch((err) => {
                    console.error("Failed to stop scanning.", err);
                });
            } else if (html5QrcodeScanner) {
                 document.getElementById('reader').style.display = 'none';
                 html5QrcodeScanner = null;
            }
        }

        /** â­ï¸ ìƒí’ˆ ì •ë³´ë¥¼ GVIZ/TQ ë°©ì‹ìœ¼ë¡œ ì¡°íšŒí•˜ëŠ” í•¨ìˆ˜ (GitHub Pages í˜¸í™˜) â­ï¸ */
        async function fetchProductInfo(barcode, formType) {
            document.getElementById('statusMessage').innerHTML = '';
            document.getElementById('pickingStatusMessage').innerHTML = '';
            document.getElementById('updateStatusMessage').innerHTML = '';

            const updateFields = (status) => {
                const value = status === 'loading' ? 'ì¡°íšŒ ì¤‘...' : 'Error';
                const empty = status === 'error' ? 'Error' : '';
                
                document.getElementById('p_itemName').value = value;
                document.getElementById('p_itemCode').value = value;
                document.getElementById('u_itemName').value = value;
                document.getElementById('u_itemCode').value = value;
                
                if (formType === 'inbound') {
                    document.getElementById('itemName').value = empty;
                    document.getElementById('itemCode').value = empty;
                }
            };
            updateFields('loading');

            // Inventory_Master ì‹œíŠ¸ êµ¬ì¡°: A=ë°”ì½”ë“œ, B=ìƒí’ˆëª…, C=ìƒí’ˆì½”ë“œ
            const query = encodeURIComponent(`SELECT B, C WHERE A = '${barcode}'`);
            
            // GVIZ/TQ ì—”ë“œí¬ì¸íŠ¸ URL ìƒì„±
            const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=${MASTER_SHEET_GID}&tq=${query}`;

            if (SHEET_ID === 'YOUR_DOCUMENT_ID_HERE') {
                 alert('ğŸš¨ SHEET_IDë¥¼ ì„¤ì •í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ ìƒë‹¨ ìƒìˆ˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                 updateFields('error');
                 return;
            }

            try {
                const response = await fetch(url);
                const responseText = await response.text();
                
                // Gviz ì‘ë‹µì—ì„œ JSON ë°ì´í„°ë§Œ ì¶”ì¶œ
                const jsonText = responseText.substring(responseText.indexOf('{'), responseText.lastIndexOf('}') + 1);
                const result = JSON.parse(jsonText);

                if (result.table.rows.length > 0) {
                    // ê²°ê³¼ í–‰ì´ ìˆì„ ê²½ìš°
                    const itemData = result.table.rows[0].c;
                    const itemName = itemData[0] ? itemData[0].v : 'N/A'; // Bì—´ (ìƒí’ˆëª…)
                    const itemCode = itemData[1] ? itemData[1].v : 'N/A'; // Cì—´ (ìƒí’ˆì½”ë“œ)

                    // ì„±ê³µì ìœ¼ë¡œ í•„ë“œ ê¸°ì…
                    if (formType === 'inbound') {
                        document.getElementById('itemName').value = itemName;
                        document.getElementById('itemCode').value = itemCode;
                    } 
                    document.getElementById('p_itemName').value = itemName;
                    document.getElementById('p_itemCode').value = itemCode;
                    document.getElementById('u_itemName').value = itemName;
                    document.getElementById('u_itemCode').value = itemCode;

                } else {
                    // ìƒí’ˆ ì •ë³´ ì—†ìŒ
                    updateFields('notfound');
                    if (formType === 'inbound') {
                        document.getElementById('itemName').value = '';
                        document.getElementById('itemCode').value = '';
                        alert(`âš ï¸ ${barcode}ì˜ ìƒí’ˆ ì •ë³´ê°€ ë§ˆìŠ¤í„°ì— ì—†ìŠµë‹ˆë‹¤. ì…ê³  ì‹œ ìƒí’ˆëª…/ìƒí’ˆì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ ì‹ ê·œ ë“±ë¡ë©ë‹ˆë‹¤.`);
                    } else {
                        document.getElementById('p_itemName').value = 'N/A';
                        document.getElementById('p_itemCode').value = 'N/A';
                        document.getElementById('u_itemName').value = 'N/A';
                        document.getElementById('u_itemCode').value = 'N/A';
                        alert(`âš ï¸ ${barcode}ì˜ ì¬ê³  ì •ë³´ê°€ ë§ˆìŠ¤í„°ì— ì—†ìŠµë‹ˆë‹¤.`);
                    }
                }
            } catch (error) {
                console.error('ìƒí’ˆ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
                updateFields('error');
                alert(`ğŸ”´ GVIZ/TQ í†µì‹ /íŒŒì‹± ì˜¤ë¥˜ ë°œìƒ: ${error.message}. SHEET_ID ë° ì‹œíŠ¸ì˜ 'ì›¹ì— ê²Œì‹œ' ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.`);
            }
        }

        
        function getActiveFormType() {
             if (document.getElementById('tabInbound').classList.contains('active')) return 'inbound';
             if (document.getElementById('tabOutbound').classList.contains('active')) return 'outbound';
             if (document.getElementById('tabUpdate').classList.contains('active')) return 'update';
             return '';
        }

        // **********************************************
        // 4. ë™ì  í¼ ì „í™˜ (ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€)
        // **********************************************

        function switchForm(type) {
            const forms = {
                'inbound': document.getElementById('inboundFormContainer'),
                'outbound': document.getElementById('outboundFormContainer'),
                'update': document.getElementById('stockUpdateFormContainer')
            };
            const tabs = {
                'inbound': document.getElementById('tabInbound'),
                'outbound': document.getElementById('tabOutbound'),
                'update': document.getElementById('tabUpdate')
            };

            for (let key in forms) {
                forms[key].style.display = (key === type) ? 'block' : 'none';
                if (key === type) {
                    tabs[key].classList.add('active');
                    attachLocationListeners(key);
                } else {
                    tabs[key].classList.remove('active');
                }
            }
            // ë©”ì‹œì§€ ì´ˆê¸°í™”
            statusMessage.innerHTML = '';
            pickingStatusMessage.innerHTML = '';
            updateStatusMessage.innerHTML = '';
        }

        // **********************************************
        // 5. API í†µì‹  ë° í¼ ì œì¶œ (POST) - fetch ì‚¬ìš© (doPost)
        // **********************************************

        /** API í˜¸ì¶œ ê³µí†µ í•¨ìˆ˜ (POST ìš”ì²­ì€ fetch ìœ ì§€) */
        async function sendDataToGAS(data, statusElement) {
            statusElement.classList.remove('success', 'error');
            statusElement.textContent = 'ì²˜ë¦¬ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
            
            const TIMEOUT_DURATION = 8000; 
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), TIMEOUT_DURATION);
        
            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'text/plain;charset=utf-8', 
                    },
                    body: JSON.stringify(data),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
        
                if (response.ok) {
                    const responseText = await response.text();
                    
                    // 1. GASê°€ ë¹ˆ ì‘ë‹µì„ ë³´ëƒˆë‹¤ë©´ (ì˜ë„ëœ ì„±ê³µ)
                    if (responseText === '') {
                        statusElement.classList.add('success');
                        statusElement.textContent = 'âœ… ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ';
                        return true;
                    }
                    
                    // 2. GASê°€ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ ë³¸ë¬¸ìœ¼ë¡œ ë³´ëƒˆë‹¤ë©´ (ë¡œì§ ì˜¤ë¥˜)
                    if (responseText.includes('ERROR:') || responseText.includes('RUNTIME ERROR:')) {
                        statusElement.classList.add('error');
                        // ì˜¤ë¥˜ ë©”ì‹œì§€ì—ì„œ 'ERROR:' ë¶€ë¶„ì„ ì œì™¸í•˜ê³  ì‚¬ìš©ìì—ê²Œ í‘œì‹œ
                        const errorMessage = responseText.replace('ERROR: ', '').replace('RUNTIME ERROR: ', '');
                        statusElement.textContent = `âŒ ì„œë²„ ë¡œì§ ì˜¤ë¥˜: ${errorMessage}`;
                        console.error('GAS Logic Error:', responseText);
                        return false;
                    }
        
                    // 3. ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ
                     statusElement.classList.add('error');
                     statusElement.textContent = 'âŒ ì•Œ ìˆ˜ ì—†ëŠ” ì„œë²„ ì‘ë‹µ. ì‹œíŠ¸ ê¸°ë¡ ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
                     return false;
                }
        
                // 4. HTTP ìƒíƒœ ì½”ë“œê°€ 200ì´ ì•„ë‹Œ ê²½ìš°
                throw new Error(`HTTP í†µì‹  ì‹¤íŒ¨: ${response.status} ${response.statusText}`);
        
            } catch (error) {
                clearTimeout(timeoutId);
                
                // ** ë„¤íŠ¸ì›Œí¬/íƒ€ì„ì•„ì›ƒ ì˜¤ë¥˜ ë°œìƒ ì‹œ (Load Failed, AbortError ë“±) **
                statusElement.classList.add('error'); 
                // ì„œë²„ ë¡œì§ì€ ì‹¤í–‰ë˜ì—ˆì„ ìˆ˜ ìˆì§€ë§Œ, í´ë¼ì´ì–¸íŠ¸ì—ê²ŒëŠ” ì‹¤íŒ¨ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ì—¬ ì¬ì‹œë„ë¥¼ ìœ ë„í•©ë‹ˆë‹¤.
                statusElement.textContent = `âŒ í†µì‹  ì‹¤íŒ¨: ì„œë²„ ì—°ê²° ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜. (ë©”ì‹œì§€: ${error.name || error.message}). Google Sheetsë¥¼ ì§ì ‘ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.`;
                console.error('Network/Timeout Error:', error);
                return false; 
            }
        }

        // --- í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ: ì…ê³  í¼ ---
        const locationForm = document.getElementById('locationForm');
        locationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // â­ï¸ í•„ìˆ˜ ì…ë ¥ ê²€ì¦ ê°•í™” (ëŒ€í™”ìƒì ë³´ì¥) â­ï¸
            const fullLocationValue = document.getElementById('fullLocation').value.trim();
            const barcodeValue = document.getElementById('barcode').value.trim();
            const itemNameValue = document.getElementById('itemName').value.trim();
            const itemCodeValue = document.getElementById('itemCode').value.trim();
            const batchNoValue = document.getElementById('batchNo').value.trim();
            const quantityValue = document.getElementById('quantity').value;
            const responsiblePersonValue = document.getElementById('responsiblePerson').value.trim();

            if (!fullLocationValue || !barcodeValue || !itemNameValue || !itemCodeValue || 
                !batchNoValue || !quantityValue || parseInt(quantityValue, 10) <= 0 || !responsiblePersonValue) 
            {
                alert('ğŸš¨ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì„ ëª¨ë‘ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\n(ë¡œì¼€ì´ì…˜, ë°”ì½”ë“œ, ìƒí’ˆëª…, ìƒí’ˆì½”ë“œ, ë°°ì¹˜ë²ˆí˜¸, ìˆ˜ëŸ‰ì€ 1 ì´ìƒ, ë‹´ë‹¹ì)');
                return;
            }

            const fullLocationParts = fullLocationValue.split('-'); 
            const rackType = fullLocationParts[0]; 
            const locationCode = fullLocationParts.slice(1).join('-'); 
            
            const data = {
                barcode: barcodeValue,
                batchNo: batchNoValue,
                rackType: rackType,
                location: locationCode, 
                quantity: parseInt(quantityValue, 10), // ì…ê³ ëŠ” ì–‘ìˆ˜
                itemName: itemNameValue,
                itemCode: itemCodeValue,
                responsiblePerson: responsiblePersonValue, 
                action: "INBOUND"
            };
            
            const success = await sendDataToGAS(data, statusMessage);
            if (success) {
                locationForm.reset();
                document.getElementById('quantity').value = '1';
                updateLocationField('inbound'); 
                document.getElementById('barcode').focus();
                // ë‹´ë‹¹ì ë“œë¡­ë‹¤ìš´ì˜ ì„ íƒ ê°’ì€ ìœ ì§€
                document.getElementById('responsiblePerson').value = responsiblePersonValue;
            }
        });

        // --- í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ: ì¶œê³  í¼ ---
        const pickingForm = document.getElementById('pickingForm');
        pickingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // â­ï¸ í•„ìˆ˜ ì…ë ¥ ê²€ì¦ ê°•í™” â­ï¸
            const pFullLocationValue = document.getElementById('p_fullLocation').value.trim();
            const pBarcodeValue = document.getElementById('p_barcode').value.trim();
            const pBatchNoValue = document.getElementById('p_batchNo').value.trim();
            const pQuantityValue = document.getElementById('p_quantity').value;
            const pResponsiblePersonValue = document.getElementById('p_responsiblePerson').value.trim();

            if (!pFullLocationValue || !pBarcodeValue || !pBatchNoValue || 
                !pQuantityValue || parseInt(pQuantityValue, 10) <= 0 || !pResponsiblePersonValue) 
            {
                alert('ğŸš¨ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì„ ëª¨ë‘ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\n(ë¡œì¼€ì´ì…˜, ë°”ì½”ë“œ, ë°°ì¹˜ë²ˆí˜¸, ìˆ˜ëŸ‰ì€ 1 ì´ìƒ, ë‹´ë‹¹ì)');
                return;
            }

            const qtyToSubtract = parseInt(pQuantityValue, 10) * -1;

            const fullLocationParts = pFullLocationValue.split('-'); 
            const rackType = fullLocationParts[0]; 
            const locationCode = fullLocationParts.slice(1).join('-');
            
            const data = {
                barcode: pBarcodeValue,
                batchNo: pBatchNoValue,
                rackType: rackType,
                location: locationCode, 
                quantity: qtyToSubtract, // ì¶œê³ ëŠ” ìŒìˆ˜
                itemName: document.getElementById('p_itemName').value.trim(),
                itemCode: document.getElementById('p_itemCode').value.trim(),
                responsiblePerson: pResponsiblePersonValue, 
                action: "OUTBOUND"
            };

            const success = await sendDataToGAS(data, pickingStatusMessage);
            if (success) {
                pickingForm.reset();
                document.getElementById('p_quantity').value = '1';
                updateLocationField('outbound'); 
                document.getElementById('p_barcode').focus();
                // ë‹´ë‹¹ì ë“œë¡­ë‹¤ìš´ì˜ ì„ íƒ ê°’ì€ ìœ ì§€
                document.getElementById('p_responsiblePerson').value = pResponsiblePersonValue;
            }
        });
        
        // --- í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ: ì¬ê³  ìˆ˜ì • í¼ ---
        const stockUpdateForm = document.getElementById('stockUpdateForm');
        stockUpdateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // â­ï¸ í•„ìˆ˜ ì…ë ¥ ê²€ì¦ ê°•í™” â­ï¸
            const uFullLocationValue = document.getElementById('u_fullLocation').value.trim();
            const uBarcodeValue = document.getElementById('u_barcode').value.trim();
            const uBatchNoValue = document.getElementById('u_batchNo').value.trim();
            const uCurrentQuantityValue = document.getElementById('u_currentQuantity').value;
            const uResponsiblePersonValue = document.getElementById('u_responsiblePerson').value.trim();

            if (!uFullLocationValue || !uBarcodeValue || !uBatchNoValue || 
                uCurrentQuantityValue === undefined || parseInt(uCurrentQuantityValue, 10) < 0 || !uResponsiblePersonValue) 
            {
                alert('ğŸš¨ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì„ ëª¨ë‘ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\n(ë¡œì¼€ì´ì…˜, ë°”ì½”ë“œ, ë°°ì¹˜ë²ˆí˜¸, ìµœì¢… ì‹¤ì‚¬ ìˆ˜ëŸ‰ì€ 0 ì´ìƒ, ë‹´ë‹¹ì)');
                return;
            }
            
            const fullLocationParts = uFullLocationValue.split('-'); 
            const rackType = fullLocationParts[0]; 
            const locationCode = fullLocationParts.slice(1).join('-');
            
            const data = {
                barcode: uBarcodeValue,
                batchNo: uBatchNoValue,
                rackType: rackType,
                location: locationCode, 
                currentQuantity: uCurrentQuantityValue, 
                itemName: document.getElementById('u_itemName').value.trim(),
                itemCode: document.getElementById('u_itemCode').value.trim(),
                responsiblePerson: uResponsiblePersonValue, 
                action: "UPDATE_STOCK" 
            };
            
            const success = await sendDataToGAS(data, updateStatusMessage);
            if (success) {
                stockUpdateForm.reset();
                document.getElementById('u_currentQuantity').value = '0';
                updateLocationField('update'); 
                document.getElementById('u_barcode').focus();
                // ë‹´ë‹¹ì ë“œë¡­ë‹¤ìš´ì˜ ì„ íƒ ê°’ì€ ìœ ì§€
                document.getElementById('u_responsiblePerson').value = uResponsiblePersonValue;
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            switchForm('inbound');
        });
    </script>
</body>
</html>




