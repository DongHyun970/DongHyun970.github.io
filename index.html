<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ ì¬ê³  ë¡œì¼€ì´ì…˜</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #28a745;
            --danger-color: #dc3545;
            --info-color: #ffc107; /* ì¬ê³  ìˆ˜ì • ìƒ‰ìƒ ì¶”ê°€ */
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #343a40;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        body { 
            font-family: 'Roboto', sans-serif; 
            padding: 0; 
            margin: 0; 
            background-color: var(--background-color); 
            color: var(--text-color);
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px;
        }
        h1 { 
            font-size: 24px; 
            text-align: center; 
            color: var(--primary-color); 
            margin-bottom: 20px;
        }
        h2 {
            font-size: 18px;
            color: var(--text-color);
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 5px;
            margin-top: 20px;
        }
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tab-controls {
            display: grid; /* ê·¸ë¦¬ë“œ ì‚¬ìš© */
            grid-template-columns: repeat(3, 1fr); /* 3ê°œ íƒ­ */
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        .tab-controls button {
            padding: 15px;
            border: none;
            background-color: #e9ecef;
            color: var(--text-color);
            font-size: 14px; /* í°íŠ¸ í¬ê¸° ì¡°ì • */
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .tab-controls button.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        /* ì¹´ë“œ, í¼ ìš”ì†Œ, ìŠ¤ìºë„ˆ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ì€ ì´ì „ê³¼ ë™ì¼ */
        .card {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        input:not([type="radio"]), select, button[type="submit"] { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 12px; 
            box-sizing: border-box; 
            border: 1px solid #ced4da; 
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .action-button { 
            background-color: var(--secondary-color); 
            color: white; 
        }
        .action-button:hover { 
            background-color: #1e7e34; 
        }
        #pickingForm .action-button { 
            background-color: var(--danger-color); 
        }
        #pickingForm .action-button:hover { 
            background-color: #bd2130; 
        }
        #stockUpdateForm .action-button { 
            background-color: var(--info-color); 
            color: var(--text-color);
        }
        #stockUpdateForm .action-button:hover { 
            background-color: #e0a800; 
        }
        .location-group {
            display: flex;
            gap: 5px;
            margin-bottom: 12px;
        }
        .location-group input, .location-group select {
            flex: 1;
            text-align: center;
        }
        #reader { 
            width: 100%; 
            max-width: 400px; 
            margin: 15px auto; 
            border: 1px solid #ccc; 
            border-radius: 8px;
            overflow: hidden;
        }
        .success { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; padding: 10px; border-radius: 4px; margin-top: 15px; }
        .error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; border-radius: 4px; margin-top: 15px; }
        input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ìŠ¤ë§ˆíŠ¸ ì¬ê³  ë¡œì¼€ì´ì…˜ ì‹œìŠ¤í…œ</h1>

        <div class="tab-controls">
            <button id="tabInbound" onclick="switchForm('inbound')" class="active">â¬†ï¸ ì…ê³ </button>
            <button id="tabOutbound" onclick="switchForm('outbound')">â¬‡ï¸ ì¶œê³ </button>
            <button id="tabUpdate" onclick="switchForm('update')">ğŸ”„ ì¬ê³  ìˆ˜ì •/ì´ë™</button>
        </div>

        <div id="scannerSection" class="card">
            <h2>ìŠ¤ìºë„ˆ ì»¨íŠ¸ë¡¤</h2>
            <div class="scanner-controls">
                <button onclick="startScanner('barcode')">ìƒí’ˆ ë°”ì½”ë“œ ìŠ¤ìº”</button>
                <button onclick="startScanner('location')">ë¡œì¼€ì´ì…˜ ìŠ¤ìº”</button>
                <button onclick="stopScanner()">ìŠ¤ìºë„ˆ ë„ê¸°</button>
            </div>
            <div id="reader"></div>
        </div>

        <div id="inboundFormContainer" class="card">
            <h2>ì…ê³  ì •ë³´</h2>
            <form id="locationForm">
                
                <div class="form-group">
                    <label>ë™ ë¡œì¼€ì´ì…˜ (A-01-01-01):</label>
                    <div class="location-group">
                        <select id="rackType" required onchange="updateLocationField()">
                            <option value="">ë™</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                        <input type="number" id="rackCol" placeholder="ì—´ (01)" required min="1" max="99" oninput="updateLocationField()">
                        <input type="number" id="rackFloor" placeholder="ì¸µ (01)" required min="1" max="99" oninput="updateLocationField()">
                        <select id="rackSide" required onchange="updateLocationField()">
                            <option value="">ì¢Œ/ìš°</option>
                            <option value="1">1 (ì¢Œ)</option>
                            <option value="2">2 (ìš°)</option>
                        </select>
                    </div>
                    <input type="text" id="fullLocation" placeholder="A-01-01-01 í˜•ì‹ìœ¼ë¡œ ìë™ ì…ë ¥ë©ë‹ˆë‹¤" required readonly>
                </div>

                <div class="form-group">
                    <label for="barcode">ìƒí’ˆ ë°”ì½”ë“œ:</label>
                    <input type="text" id="barcode" placeholder="ìŠ¤ìº” ë˜ëŠ” ì…ë ¥" required>
                </div>
                
                <div class="form-group">
                    <label for="itemName">ìƒí’ˆëª…:</label>
                    <input type="text" id="itemName" placeholder="ìë™ ê¸°ì… / ì‹ ê·œ ë“±ë¡ ì‹œ ì…ë ¥" required>
                </div>

                <div class="form-group">
                    <label for="itemCode">ìƒí’ˆì½”ë“œ:</label>
                    <input type="text" id="itemCode" placeholder="ìë™ ê¸°ì… / ì‹ ê·œ ë“±ë¡ ì‹œ ì…ë ¥" required>
                </div>

                <div class="form-group">
                    <label for="batchNo">ë°°ì¹˜ë²ˆí˜¸ (ë‚ ì§œ ë“±):</label>
                    <input type="text" id="batchNo" placeholder="ë°°ì¹˜ë²ˆí˜¸ ì…ë ¥/ìŠ¤ìº”" required>
                </div>
                
                <div class="form-group">
                    <label for="quantity">ìˆ˜ëŸ‰ (ì…ê³ ):</label>
                    <input type="number" id="quantity" value="1" min="1" required>
                </div>

                <button type="submit" class="action-button">âœ… ë¡œì¼€ì´ì…˜ ì§€ì • ë° ì…ê³ </button>
            </form>
            <div id="statusMessage"></div>
        </div>

        <div id="outboundFormContainer" class="card" style="display:none;">
            <h2>ì¶œê³  ì •ë³´</h2>
            <form id="pickingForm">
                <div class="form-group">
                    <label for="p_barcode">ì¶œê³  ìƒí’ˆ ë°”ì½”ë“œ:</label>
                    <input type="text" id="p_barcode" placeholder="ìŠ¤ìº” ë˜ëŠ” ì…ë ¥" required>
                </div>
                
                <div class="form-group">
                    <label for="p_itemName">ìƒí’ˆëª…:</label>
                    <input type="text" id="p_itemName" placeholder="ìë™ ê¸°ì…" readonly>
                </div>
                
                <div class="form-group">
                    <label for="p_itemCode">ìƒí’ˆì½”ë“œ:</label>
                    <input type="text" id="p_itemCode" placeholder="ìë™ ê¸°ì…" readonly>
                </div>
                
                <div class="form-group">
                    <label for="p_batchNo">ì¶œê³  ë°°ì¹˜ë²ˆí˜¸:</label>
                    <input type="text" id="p_batchNo" placeholder="ì¶œê³  ë°°ì¹˜ë²ˆí˜¸" required>
                </div>
                
                <div class="form-group">
                    <label for="p_fullLocation">ì¶œê³  ë¡œì¼€ì´ì…˜:</label>
                    <input type="text" id="p_fullLocation" placeholder="ì¶œê³  ë¡œì¼€ì´ì…˜ (A-01-01-01 í˜•ì‹, ìŠ¤ìº” ë˜ëŠ” ì…ë ¥)" required>
                </div>
                
                <div class="form-group">
                    <label for="p_quantity">ìˆ˜ëŸ‰ (ì¶œê³ ):</label>
                    <input type="number" id="p_quantity" value="1" min="1" required>
                </div>

                <button type="submit" class="action-button">ğŸ”´ ì¬ê³  ì¶œê³  ì²˜ë¦¬</button>
            </form>
            <div id="pickingStatusMessage"></div>
        </div>

        <div id="stockUpdateFormContainer" class="card" style="display:none;">
            <h2>ì¬ê³  ìˆ˜ì • (ì‹¤ì‚¬, ì´ë™ í›„ ìˆ˜ëŸ‰ ì¡°ì •)</h2>
            <form id="stockUpdateForm">
                <div class="form-group">
                    <label for="u_barcode">ìƒí’ˆ ë°”ì½”ë“œ:</label>
                    <input type="text" id="u_barcode" placeholder="ìŠ¤ìº” ë˜ëŠ” ì…ë ¥" required>
                </div>
                
                <div class="form-group">
                    <label for="u_itemName">ìƒí’ˆëª…:</label>
                    <input type="text" id="u_itemName" placeholder="ìë™ ê¸°ì…" readonly>
                </div>
                
                <div class="form-group">
                    <label for="u_itemCode">ìƒí’ˆì½”ë“œ:</label>
                    <input type="text" id="u_itemCode" placeholder="ìë™ ê¸°ì…" readonly>
                </div>
                
                <div class="form-group">
                    <label for="u_batchNo">ë°°ì¹˜ë²ˆí˜¸:</label>
                    <input type="text" id="u_batchNo" placeholder="ë°°ì¹˜ë²ˆí˜¸" required>
                </div>
                
                <div class="form-group">
                    <label for="u_fullLocation">ë¡œì¼€ì´ì…˜:</label>
                    <input type="text" id="u_fullLocation" placeholder="ë¡œì¼€ì´ì…˜ (A-01-01-01 í˜•ì‹)" required>
                </div>
                
                <div class="form-group">
                    <label for="u_currentQuantity">**ìµœì¢… ì‹¤ì‚¬ ìˆ˜ëŸ‰**:</label>
                    <input type="number" id="u_currentQuantity" value="0" min="0" required>
                    <small>ì´ ë¡œì¼€ì´ì…˜ì˜ ì¬ê³ ë¥¼ ì…ë ¥ëœ ìˆ˜ëŸ‰ìœ¼ë¡œ **ë®ì–´ì”ë‹ˆë‹¤**.</small>
                </div>

                <button type="submit" class="action-button">ğŸ”„ ì¬ê³  ìˆ˜ëŸ‰ìœ¼ë¡œ ìˆ˜ì •</button>
            </form>
            <div id="updateStatusMessage"></div>
        </div>
        
        <div class="card">
            <h2>ğŸ“Š ë¬¼í’ˆ ì „ì²´ ì¬ê³  í˜„í™©</h2>
            <p>ì „ì²´ ë¬¼í’ˆ ê´€ë¦¬ëŠ” Google Sheetsë¥¼ **ì§ì ‘ ì—´ì–´** `Inventory_Master` ì‹œíŠ¸ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            <p>ì›¹ ì•± ë‚´ì— ë³„ë„ì˜ ì¡°íšŒ í˜ì´ì§€ë¥¼ êµ¬ì¶•í•˜ë ¤ë©´ ì¶”ê°€ì ì¸ GAS `doGet` ê¸°ëŠ¥ êµ¬í˜„ ë° ì›¹ í˜ì´ì§€ ê°œë°œì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
        </div>

    </div>

    <script>
        // ğŸš¨ ì¤‘ìš”: ì—¬ê¸°ì— GAS ì›¹ ì•± URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbyzy-oeFZzuf1yxIU7nWUwtROQg3kBxSSJzAvzkIVFUhAo6-2o-ErLIMQCdZGpR39G12Q/exec'; 
        
        // **********************************************
        // 1. ìƒíƒœ ë³€ìˆ˜ ë° ìœ í‹¸ë¦¬í‹°
        // **********************************************

        let html5QrcodeScanner;
        let currentScanTarget = ''; 

        const statusMessage = document.getElementById('statusMessage');
        const pickingStatusMessage = document.getElementById('pickingStatusMessage');
        const updateStatusMessage = document.getElementById('updateStatusMessage');
        
        // ìˆ«ìë¥¼ ë‘ ìë¦¬ ë¬¸ìì—´ë¡œ ë³€í™˜ (ì¢Œìš°ë„ 01, 02ë¡œ ì²˜ë¦¬)
        const padTwoDigits = (num) => String(num).padStart(2, '0');

        // **********************************************
        // 2. ë¡œì¼€ì´ì…˜ í•„ë“œ ê´€ë¦¬
        // **********************************************

        /** ë¡œì¼€ì´ì…˜ ê·¸ë£¹ í•„ë“œ ê°’ë“¤ì„ í•©ì³ ìµœì¢… ë¡œì¼€ì´ì…˜ í•„ë“œì— ë°˜ì˜í•©ë‹ˆë‹¤. (A-01-01-01 í˜•ì‹ ê°•ì œ) */
        function updateLocationField() {
            const rackType = document.getElementById('rackType').value;
            let rackCol = document.getElementById('rackCol').value;
            let rackFloor = document.getElementById('rackFloor').value;
            let rackSide = document.getElementById('rackSide').value; // 1 ë˜ëŠ” 2
            
            const fullLocationField = document.getElementById('fullLocation');
            
            // ë‘ ìë¦¬ ìˆ«ì í¬ë§· ê°•ì œ
            if (rackCol) rackCol = padTwoDigits(rackCol);
            if (rackFloor) rackFloor = padTwoDigits(rackFloor);
            // ì¢Œìš°(Side)ë„ ë‘ ìë¦¬ í¬ë§· ê°•ì œ (01, 02)
            if (rackSide) rackSide = padTwoDigits(rackSide);
            
            // ë¡œì¼€ì´ì…˜ ì½”ë“œ: ì—´-ì¸µ-ì¢Œìš° (ex: 01-01-01)
            const locationCode = (rackCol && rackFloor && rackSide) ? `${rackCol}-${rackFloor}-${rackSide}` : '';
            
            if (rackType && locationCode) {
                // ìµœì¢… ì „ì²´ ë¡œì¼€ì´ì…˜: ë™-ì—´-ì¸µ-ì¢Œìš° (ex: A-01-01-01)
                fullLocationField.value = `${rackType}-${locationCode}`;
            } else {
                fullLocationField.value = '';
            }
        }

        // **********************************************
        // 3. ìŠ¤ìºë„ˆ ë° ë°”ì½”ë“œ ìë™ ì™„ì„±
        // **********************************************

        function onScanSuccess(decodedText) {
            stopScanner();
            
            if (currentScanTarget === 'barcode') {
                // í˜„ì¬ í™œì„±í™”ëœ í¼ì— ë”°ë¼ ë°”ì½”ë“œ í•„ë“œ ì—…ë°ì´íŠ¸
                const activeForm = getActiveFormType();
                
                document.getElementById('barcode').value = decodedText;
                document.getElementById('p_barcode').value = decodedText;
                document.getElementById('u_barcode').value = decodedText;
                
                fetchProductInfo(decodedText, activeForm); 
                
                // í¬ì»¤ìŠ¤ ì´ë™
                if (activeForm === 'inbound') document.getElementById('itemName').focus();
                else if (activeForm === 'outbound') document.getElementById('p_batchNo').focus();
                else if (activeForm === 'update') document.getElementById('u_batchNo').focus();

            } else if (currentScanTarget === 'location') {
                // ë¡œì¼€ì´ì…˜ ìŠ¤ìº” ì‹œ (A-01-01-01 í˜•ì‹ ê°€ì •)
                document.getElementById('p_fullLocation').value = decodedText; 
                document.getElementById('u_fullLocation').value = decodedText;
                
                // ì…ê³  í¼ì€ ìƒì„¸ í•„ë“œ ì±„ìš°ê¸°
                const parts = decodedText.split('-');
                if(parts.length === 4) {
                    document.getElementById('rackType').value = parts[0];
                    // parts[1], parts[2], parts[3]ì€ ì´ë¯¸ '01'ê³¼ ê°™ì€ í¬ë§·ì´ë¯€ë¡œ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                    document.getElementById('rackCol').value = parseInt(parts[1], 10);
                    document.getElementById('rackFloor').value = parseInt(parts[2], 10);
                    document.getElementById('rackSide').value = parseInt(parts[3], 10);
                    
                    updateLocationField();
                }
                
                // í¬ì»¤ìŠ¤ ì´ë™
                if (getActiveFormType() === 'inbound') document.getElementById('quantity').focus();
                else if (getActiveFormType() === 'update') document.getElementById('u_currentQuantity').focus();
                else document.getElementById('p_quantity').focus();
            }
        }
        
        /** ìƒí’ˆ ì •ë³´ë¥¼ GASë¡œë¶€í„° ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (ìë™ ê¸°ì… ì‹œ ê¸°ì¡´ ê°’ ìœ ì§€ ë¡œì§ ì¶”ê°€) */
        async function fetchProductInfo(barcode, formType) {
            try {
                const url = `${GAS_API_URL}?action=GET_ITEM&barcode=${barcode}`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.success && result.item) {
                    // ì…ê³  í¼: ê¸°ì¡´ ê°’ì´ ì—†ìœ¼ë©´ ìë™ ê¸°ì…
                    if (formType === 'inbound' && !document.getElementById('itemName').value) {
                        document.getElementById('itemName').value = result.item.itemName;
                        document.getElementById('itemCode').value = result.item.itemCode;
                    } 
                    // ì¶œê³ /ìˆ˜ì • í¼: ë¬´ì¡°ê±´ ìë™ ê¸°ì… (read-only í•„ë“œ)
                    document.getElementById('p_itemName').value = result.item.itemName;
                    document.getElementById('p_itemCode').value = result.item.itemCode;
                    document.getElementById('u_itemName').value = result.item.itemName;
                    document.getElementById('u_itemCode').value = result.item.itemCode;
                } else {
                    // ìƒí’ˆ ì •ë³´ ì—†ìŒ
                    if (formType === 'inbound') {
                        document.getElementById('itemName').value = '';
                        document.getElementById('itemCode').value = '';
                        alert('ìƒí’ˆ ì •ë³´ê°€ ë§ˆìŠ¤í„°ì— ì—†ìŠµë‹ˆë‹¤. ìƒí’ˆëª…ê³¼ ìƒí’ˆì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ ì‹ ê·œ ë“±ë¡ë©ë‹ˆë‹¤.');
                    } else {
                        // ì¶œê³ /ìˆ˜ì •ì€ ë§ˆìŠ¤í„°ì— ì—†ìœ¼ë©´ ì‘ì—… ë¶ˆê°€
                        document.getElementById('p_itemName').value = 'N/A';
                        document.getElementById('p_itemCode').value = 'N/A';
                        document.getElementById('u_itemName').value = 'N/A';
                        document.getElementById('u_itemCode').value = 'N/A';
                        alert('ì¶œê³ /ìˆ˜ì • ì‘ì—…: ë§ˆìŠ¤í„°ì— ì—†ëŠ” ìƒí’ˆì€ ë“±ë¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                }
            } catch (error) {
                console.error('ìƒí’ˆ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
            }
        }

        // ... (startScanner, stopScanner í•¨ìˆ˜ëŠ” ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤) ...
        function startScanner(target) {
            currentScanTarget = target;
            stopScanner(); 
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess,
                (errorMessage) => { /* ìŠ¤ìº” ì—ëŸ¬ ë¬´ì‹œ */ }
            ).catch((err) => {
                alert(`ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: ${err}. HTTPS í™˜ê²½ì„ í™•ì¸í•˜ì„¸ìš”.`);
            });
            document.getElementById('reader').style.display = 'block';
            document.getElementById('reader').scrollIntoView({ behavior: 'smooth' });
        }
        
        function stopScanner() {
            if (html5QrcodeScanner && html5QrcodeScanner.isScanning) { 
                html5QrcodeScanner.stop().then(() => {
                    document.getElementById('reader').style.display = 'none';
                    html5QrcodeScanner = null;
                }).catch((err) => {
                    console.error("Failed to stop scanning.", err);
                });
            } else if (html5QrcodeScanner) {
                 document.getElementById('reader').style.display = 'none';
                 html5QrcodeScanner = null;
            }
        }
        
        function getActiveFormType() {
             if (document.getElementById('tabInbound').classList.contains('active')) return 'inbound';
             if (document.getElementById('tabOutbound').classList.contains('active')) return 'outbound';
             if (document.getElementById('tabUpdate').classList.contains('active')) return 'update';
             return '';
        }

        // **********************************************
        // 4. ë™ì  í¼ ì „í™˜
        // **********************************************

        /** ì…ê³ /ì¶œê³ /ìˆ˜ì • í¼ ì „í™˜ */
        function switchForm(type) {
            const forms = {
                'inbound': document.getElementById('inboundFormContainer'),
                'outbound': document.getElementById('outboundFormContainer'),
                'update': document.getElementById('stockUpdateFormContainer')
            };
            const tabs = {
                'inbound': document.getElementById('tabInbound'),
                'outbound': document.getElementById('tabOutbound'),
                'update': document.getElementById('tabUpdate')
            };

            for (let key in forms) {
                forms[key].style.display = (key === type) ? 'block' : 'none';
                if (key === type) {
                    tabs[key].classList.add('active');
                } else {
                    tabs[key].classList.remove('active');
                }
            }
            // ë©”ì‹œì§€ ì´ˆê¸°í™”
            statusMessage.innerHTML = '';
            pickingStatusMessage.innerHTML = '';
            updateStatusMessage.innerHTML = '';
        }

        // **********************************************
        // 5. API í†µì‹  ë° í¼ ì œì¶œ
        // **********************************************

        // ... (sendDataToGAS í•¨ìˆ˜ëŠ” ì´ì „ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€ë©ë‹ˆë‹¤) ...
        async function sendDataToGAS(data, statusElement) {
            statusElement.innerHTML = 'ì²˜ë¦¬ ì¤‘...';
            statusElement.className = '';
            
            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();

                if (result.success) {
                    statusElement.innerHTML = `SUCCESS: ${result.message}`;
                    statusElement.className = 'success';
                    return true;
                } else {
                    statusElement.innerHTML = `ERROR: ${result.message}`;
                    statusElement.className = 'error';
                    return false;
                }
            } catch (error) {
                statusElement.innerHTML = `í†µì‹  ì‹¤íŒ¨: ì„œë²„ ì—°ê²° ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ (${error.message}). GAS ë°°í¬ ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.`;
                statusElement.className = 'error';
                return false;
            }
        }

        // --- í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        const locationForm = document.getElementById('locationForm');
        const pickingForm = document.getElementById('pickingForm');
        const stockUpdateForm = document.getElementById('stockUpdateForm');
        
        // 1. ì…ê³ /ì§€ì • í¼ ì œì¶œ
        locationForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const fullLocationValue = document.getElementById('fullLocation').value.trim();
            const fullLocationParts = fullLocationValue.split('-'); 
            
            const rackType = fullLocationParts[0]; 
            const locationCode = fullLocationParts.slice(1).join('-'); // 01-01-01

            const data = {
                barcode: document.getElementById('barcode').value.trim(),
                batchNo: document.getElementById('batchNo').value.trim(),
                rackType: rackType,
                location: locationCode, 
                quantity: parseInt(document.getElementById('quantity').value, 10),
                itemName: document.getElementById('itemName').value.trim(),
                itemCode: document.getElementById('itemCode').value.trim(),
                action: "IN_LOC"
            };
            
            const success = await sendDataToGAS(data, statusMessage);
            if (success) {
                locationForm.reset();
                document.getElementById('quantity').value = '1';
                document.getElementById('fullLocation').value = '';
                updateLocationField(); // ë¡œì¼€ì´ì…˜ í•„ë“œ ì´ˆê¸°í™” í›„ ë‹¤ì‹œ ê³„ì‚°
                document.getElementById('barcode').focus();
            }
        });

        // 2. ì¶œê³  í¼ ì œì¶œ
        pickingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const qtyToSubtract = parseInt(document.getElementById('p_quantity').value, 10) * -1;

            const fullLocationValue = document.getElementById('p_fullLocation').value.trim();
            const fullLocationParts = fullLocationValue.split('-'); 
            
            const rackType = fullLocationParts[0]; 
            const locationCode = fullLocationParts.slice(1).join('-');
            
            const data = {
                barcode: document.getElementById('p_barcode').value.trim(),
                batchNo: document.getElementById('p_batchNo').value.trim(),
                rackType: rackType,
                location: locationCode, 
                quantity: qtyToSubtract, 
                itemName: document.getElementById('p_itemName').value.trim(),
                itemCode: document.getElementById('p_itemCode').value.trim(),
                action: "OUT_PICK"
            };

            const success = await sendDataToGAS(data, pickingStatusMessage);
            if (success) {
                pickingForm.reset();
                document.getElementById('p_quantity').value = '1';
                document.getElementById('p_barcode').focus();
            }
        });
        
        // 3. ì¬ê³  ìˆ˜ì • í¼ ì œì¶œ
        stockUpdateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const fullLocationValue = document.getElementById('u_fullLocation').value.trim();
            const fullLocationParts = fullLocationValue.split('-'); 
            
            const rackType = fullLocationParts[0]; 
            const locationCode = fullLocationParts.slice(1).join('-');
            
            const data = {
                barcode: document.getElementById('u_barcode').value.trim(),
                batchNo: document.getElementById('u_batchNo').value.trim(),
                rackType: rackType,
                location: locationCode, 
                currentQuantity: document.getElementById('u_currentQuantity').value, // ìµœì¢… ìˆ˜ëŸ‰
                itemName: document.getElementById('u_itemName').value.trim(),
                itemCode: document.getElementById('u_itemCode').value.trim(),
                action: "UPDATE_STOCK" // GASì—ì„œ ì¬ê³  ìˆ˜ì • ë¡œì§ì„ ì‹¤í–‰
            };
            
            const success = await sendDataToGAS(data, updateStatusMessage);
            if (success) {
                stockUpdateForm.reset();
                document.getElementById('u_currentQuantity').value = '0';
                document.getElementById('u_barcode').focus();
            }
        });

        // ì´ˆê¸° ë¡œë“œ ì‹œ ì…ê³  í¼ í™œì„±í™” ë° ë¦¬ìŠ¤ë„ˆ ì—°ê²°
        document.addEventListener('DOMContentLoaded', () => {
            switchForm('inbound');
            document.querySelectorAll('#locationForm .location-group select, #locationForm .location-group input[type="number"]').forEach(element => {
                element.addEventListener('change', updateLocationField);
                element.addEventListener('input', updateLocationField);
            });
            updateLocationField(); 
        });
    </script>
</body>
</html>
