<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ ì¬ê³  ë¡œì¼€ì´ì…˜</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ... (ê¸°ì¡´ CSS ì½”ë“œëŠ” ë™ì¼í•˜ê²Œ ìœ ì§€) ... */
        :root {
            --primary-color: #007bff;
            --secondary-color: #28a745;
            --danger-color: #dc3545;
            --info-color: #ffc107;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #343a40;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        body { 
            font-family: 'Roboto', sans-serif; 
            padding: 0; 
            margin: 0; 
            background-color: var(--background-color); 
            color: var(--text-color);
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px;
        }
        h1 { 
            font-size: 24px; 
            text-align: center; 
            color: var(--primary-color); 
            margin-bottom: 20px;
        }
        h2 {
            font-size: 18px;
            color: var(--text-color);
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 5px;
            margin-top: 20px;
        }
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tab-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        .tab-controls button {
            padding: 15px;
            border: none;
            background-color: #e9ecef;
            color: var(--text-color);
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .tab-controls button.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        /* í¼ ìš”ì†Œ */
        input:not([type="radio"]), select, button[type="submit"] { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 12px; 
            box-sizing: border-box; 
            border: 1px solid #ced4da; 
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        /* ì•¡ì…˜ ë²„íŠ¼ ìƒ‰ìƒ */
        .action-button { 
            background-color: var(--secondary-color); 
            color: white; 
        }
        #pickingForm .action-button { 
            background-color: var(--danger-color); 
        }
        #stockUpdateForm .action-button { 
            background-color: var(--info-color); 
            color: var(--text-color);
        }

        /* ë°”ì½”ë“œ ìŠ¤ìº” ë²„íŠ¼ ë””ìì¸ */
        .scanner-controls button {
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 4px;
            margin-bottom: 15px;
            width: 100%;
        }

        /* ë¡œì¼€ì´ì…˜ ì…ë ¥ ê·¸ë£¹ */
        .location-group {
            display: flex;
            gap: 5px;
            margin-bottom: 12px;
        }
        .location-group input, .location-group select {
            flex: 1;
            text-align: center;
        }
        
        #reader { 
            width: 100%; 
            max-width: 400px; 
            margin: 15px auto; 
            border: 1px solid #ccc; 
            border-radius: 8px;
            overflow: hidden;
        }
        /* ë©”ì‹œì§€ */
        .success { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; padding: 10px; border-radius: 4px; margin-top: 15px; }
        .error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; border-radius: 4px; margin-top: 15px; }

        /* ë¹„í™œì„±í™” í•„ë“œ */
        input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ìŠ¤ë§ˆíŠ¸ ì¬ê³  ë¡œì¼€ì´ì…˜ ì‹œìŠ¤í…œ</h1>

        <div class="tab-controls">
            <button id="tabInbound" onclick="switchForm('inbound')" class="active">â¬†ï¸ ì…ê³ </button>
            <button id="tabOutbound" onclick="switchForm('outbound')">â¬‡ï¸ ì¶œê³ </button>
            <button id="tabUpdate" onclick="switchForm('update')">ğŸ”„ ì¬ê³  ìˆ˜ì •/ì´ë™</button>
        </div>

        <div id="scannerSection" class="card">
            <h2>ë°”ì½”ë“œ ìŠ¤ìº”</h2>
            <div class="scanner-controls">
                <button onclick="startScanner()">ğŸ“· ìƒí’ˆ ë°”ì½”ë“œ ìŠ¤ìº” ì‹œì‘</button>
                <button onclick="stopScanner()">ìŠ¤ìºë„ˆ ë„ê¸°</button>
            </div>
            <div id="reader"></div>
        </div>

        <div id="inboundFormContainer" class="card">
            <h2>ì…ê³  ì •ë³´</h2>
            <form id="locationForm">
                
                <div class="form-group">
                    <label>ë™ ë¡œì¼€ì´ì…˜ (A-01-01-01):</label>
                    <div class="location-group">
                        <select id="rackType" required onchange="updateLocationField('inbound')">
                            <option value="">ë™</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                        <input type="number" id="rackCol" placeholder="ì—´ (01)" required min="1" max="99" oninput="updateLocationField('inbound')">
                        <input type="number" id="rackFloor" placeholder="ì¸µ (01)" required min="1" max="99" oninput="updateLocationField('inbound')">
                        <select id="rackSide" required onchange="updateLocationField('inbound')">
                            <option value="">ì¢Œ/ìš°</option>
                            <option value="1">1 (ì¢Œ)</option>
                            <option value="2">2 (ìš°)</option>
                        </select>
                    </div>
                    <input type="text" id="fullLocation" placeholder="A-01-01-01 í˜•ì‹ìœ¼ë¡œ ìë™ ì…ë ¥ë©ë‹ˆë‹¤" required readonly>
                </div>

                <div class="form-group">
                    <label for="barcode">ìƒí’ˆ ë°”ì½”ë“œ:</label>
                    <input type="text" id="barcode" placeholder="ìŠ¤ìº” ë˜ëŠ” ì…ë ¥" required>
                </div>
                
                <div class="form-group">
                    <label for="itemName">ìƒí’ˆëª…:</label>
                    <input type="text" id="itemName" placeholder="ìë™ ê¸°ì… / ì‹ ê·œ ë“±ë¡ ì‹œ ì…ë ¥" required>
                </div>

                <div class="form-group">
                    <label for="itemCode">ìƒí’ˆì½”ë“œ:</label>
                    <input type="text" id="itemCode" placeholder="ìë™ ê¸°ì… / ì‹ ê·œ ë“±ë¡ ì‹œ ì…ë ¥" required>
                </div>

                <div class="form-group">
                    <label for="batchNo">ë°°ì¹˜ë²ˆí˜¸ (ë‚ ì§œ ë“±):</label>
                    <input type="text" id="batchNo" placeholder="ë°°ì¹˜ë²ˆí˜¸ ì…ë ¥/ìŠ¤ìº”" required>
                </div>
                
                <div class="form-group">
                    <label for="quantity">ìˆ˜ëŸ‰ (ì…ê³ ):</label>
                    <input type="number" id="quantity" value="1" min="1" required>
                </div>

                <button type="submit" class="action-button">âœ… ë¡œì¼€ì´ì…˜ ì§€ì • ë° ì…ê³ </button>
            </form>
            <div id="statusMessage"></div>
        </div>

        <div id="outboundFormContainer" class="card" style="display:none;">
            <h2>ì¶œê³  ì •ë³´</h2>
            <form id="pickingForm">
                
                <div class="form-group">
                    <label>ì¶œê³  ë™ ë¡œì¼€ì´ì…˜ (A-01-01-01):</label>
                    <div class="location-group">
                        <select id="p_rackType" required onchange="updateLocationField('outbound')">
                            <option value="">ë™</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                        <input type="number" id="p_rackCol" placeholder="ì—´ (01)" required min="1" max="99" oninput="updateLocationField('outbound')">
                        <input type="number" id="p_rackFloor" placeholder="ì¸µ (01)" required min="1" max="99" oninput="updateLocationField('outbound')">
                        <select id="p_rackSide" required onchange="updateLocationField('outbound')">
                            <option value="">ì¢Œ/ìš°</option>
                            <option value="1">1 (ì¢Œ)</option>
                            <option value="2">2 (ìš°)</option>
                        </select>
                    </div>
                    <input type="text" id="p_fullLocation" placeholder="A-01-01-01 í˜•ì‹ìœ¼ë¡œ ìë™ ì…ë ¥ë©ë‹ˆë‹¤" required readonly>
                </div>
                
                <div class="form-group">
                    <label for="p_barcode">ì¶œê³  ìƒí’ˆ ë°”ì½”ë“œ:</label>
                    <input type="text" id="p_barcode" placeholder="ìŠ¤ìº” ë˜ëŠ” ì…ë ¥" required>
                </div>
                
                <div class="form-group">
                    <label for="p_itemName">ìƒí’ˆëª…:</label>
                    <input type="text" id="p_itemName" placeholder="ìë™ ê¸°ì…" readonly>
                </div>
                
                <div class="form-group">
                    <label for="p_itemCode">ìƒí’ˆì½”ë“œ:</label>
                    <input type="text" id="p_itemCode" placeholder="ìë™ ê¸°ì…" readonly>
                </div>
                
                <div class="form-group">
                    <label for="p_batchNo">ì¶œê³  ë°°ì¹˜ë²ˆí˜¸:</label>
                    <input type="text" id="p_batchNo" placeholder="ì¶œê³  ë°°ì¹˜ë²ˆí˜¸" required>
                </div>
                
                <div class="form-group">
                    <label for="p_quantity">ìˆ˜ëŸ‰ (ì¶œê³ ):</label>
                    <input type="number" id="p_quantity" value="1" min="1" required>
                </div>

                <button type="submit" class="action-button">ğŸ”´ ì¬ê³  ì¶œê³  ì²˜ë¦¬</button>
            </form>
            <div id="pickingStatusMessage"></div>
        </div>

        <div id="stockUpdateFormContainer" class="card" style="display:none;">
            <h2>ì¬ê³  ìˆ˜ì • (ì‹¤ì‚¬, ì´ë™ í›„ ìˆ˜ëŸ‰ ì¡°ì •)</h2>
            <form id="stockUpdateForm">

                <div class="form-group">
                    <label>ìˆ˜ì • ëŒ€ìƒ ë™ ë¡œì¼€ì´ì…˜ (A-01-01-01):</label>
                    <div class="location-group">
                        <select id="u_rackType" required onchange="updateLocationField('update')">
                            <option value="">ë™</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                        <input type="number" id="u_rackCol" placeholder="ì—´ (01)" required min="1" max="99" oninput="updateLocationField('update')">
                        <input type="number" id="u_rackFloor" placeholder="ì¸µ (01)" required min="1" max="99" oninput="updateLocationField('update')">
                        <select id="u_rackSide" required onchange="updateLocationField('update')">
                            <option value="">ì¢Œ/ìš°</option>
                            <option value="1">1 (ì¢Œ)</option>
                            <option value="2">2 (ìš°)</option>
                        </select>
                    </div>
                    <input type="text" id="u_fullLocation" placeholder="A-01-01-01 í˜•ì‹ìœ¼ë¡œ ìë™ ì…ë ¥ë©ë‹ˆë‹¤" required readonly>
                </div>
                
                <div class="form-group">
                    <label for="u_barcode">ìƒí’ˆ ë°”ì½”ë“œ:</label>
                    <input type="text" id="u_barcode" placeholder="ìŠ¤ìº” ë˜ëŠ” ì…ë ¥" required>
                </div>
                
                <div class="form-group">
                    <label for="u_itemName">ìƒí’ˆëª…:</label>
                    <input type="text" id="u_itemName" placeholder="ìë™ ê¸°ì…" readonly>
                </div>
                
                <div class="form-group">
                    <label for="u_itemCode">ìƒí’ˆì½”ë“œ:</label>
                    <input type="text" id="u_itemCode" placeholder="ìë™ ê¸°ì…" readonly>
                </div>
                
                <div class="form-group">
                    <label for="u_batchNo">ë°°ì¹˜ë²ˆí˜¸:</label>
                    <input type="text" id="u_batchNo" placeholder="ë°°ì¹˜ë²ˆí˜¸" required>
                </div>
                
                <div class="form-group">
                    <label for="u_currentQuantity">**ìµœì¢… ì‹¤ì‚¬ ìˆ˜ëŸ‰**:</label>
                    <input type="number" id="u_currentQuantity" value="0" min="0" required>
                    <small>ì´ ë¡œì¼€ì´ì…˜ì˜ ì¬ê³ ë¥¼ ì…ë ¥ëœ ìˆ˜ëŸ‰ìœ¼ë¡œ **ë®ì–´ì”ë‹ˆë‹¤**.</small>
                </div>

                <button type="submit" class="action-button">ğŸ”„ ì¬ê³  ìˆ˜ëŸ‰ìœ¼ë¡œ ìˆ˜ì •</button>
            </form>
            <div id="updateStatusMessage"></div>
        </div>
        
        <div class="card">
            <h2>ğŸ“Š ë¬¼í’ˆ ì „ì²´ ì¬ê³  í˜„í™©</h2>
            <p>ì „ì²´ ë¬¼í’ˆ ê´€ë¦¬ëŠ” Google Sheetsë¥¼ **ì§ì ‘ ì—´ì–´** `Inventory_Master` ì‹œíŠ¸ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

    </div>

    <script>
        // â­ï¸ google.script.run ë°©ì‹ì€ GAS_API_URLì´ í•„ìš” ì—†ìŠµë‹ˆë‹¤. 
        // POST ìš”ì²­ë§Œ URLì„ ì‚¬ìš©í•˜ë©°, ì´ëŠ” ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ í™˜ê²½ì—ì„œ ìë™ìœ¼ë¡œ ì²˜ë¦¬ë©ë‹ˆë‹¤.
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwfqgJqeE3Dfa2NtG5WiVqFWAeKM3zTSl_B2I6oBzhUS702UC20hR-8CNY4Wto1yl5bVg/exec'; 
        
        // **********************************************
        // 1. ìƒíƒœ ë³€ìˆ˜ ë° ìœ í‹¸ë¦¬í‹°
        // **********************************************

        let html5QrcodeScanner;
        
        const statusMessage = document.getElementById('statusMessage');
        const pickingStatusMessage = document.getElementById('pickingStatusMessage');
        const updateStatusMessage = document.getElementById('updateStatusMessage');
        
        // ìˆ«ìë¥¼ ë‘ ìë¦¬ ë¬¸ìì—´ë¡œ ë³€í™˜ (01, 02 ë“±)
        const padTwoDigits = (num) => String(num).padStart(2, '0');

        // **********************************************
        // 2. ë¡œì¼€ì´ì…˜ í•„ë“œ ê´€ë¦¬ (ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€)
        // **********************************************

        function updateLocationField(formType) {
            let prefix = '';
            if (formType === 'outbound') prefix = 'p_';
            else if (formType === 'update') prefix = 'u_';

            const rackTypeEl = document.getElementById(`${prefix}rackType`);
            const rackColEl = document.getElementById(`${prefix}rackCol`);
            const rackFloorEl = document.getElementById(`${prefix}rackFloor`);
            const rackSideEl = document.getElementById(`${prefix}rackSide`);
            const fullLocationField = document.getElementById(`${prefix}fullLocation`);
            
            if (!rackTypeEl || !rackColEl || !rackFloorEl || !rackSideEl || !fullLocationField) return;

            const rackType = rackTypeEl.value;
            let rackCol = rackColEl.value;
            let rackFloor = rackFloorEl.value;
            let rackSide = rackSideEl.value; 
            
            if (rackCol) rackCol = padTwoDigits(rackCol);
            if (rackFloor) rackFloor = padTwoDigits(rackFloor);
            if (rackSide) rackSide = padTwoDigits(rackSide);
            
            const locationCode = (rackCol && rackFloor && rackSide) ? `${rackCol}-${rackFloor}-${rackSide}` : '';
            
            if (rackType && locationCode) {
                fullLocationField.value = `${rackType}-${locationCode}`;
            } else {
                fullLocationField.value = '';
            }
        }

        function attachLocationListeners(formType) {
            let prefix = '';
            if (formType === 'outbound') prefix = 'p_';
            else if (formType === 'update') prefix = 'u_';
            
            const formContainerId = prefix ? `${formType}FormContainer` : 'inboundFormContainer';
            const container = document.getElementById(formContainerId);
            
            if (container) {
                const elements = container.querySelectorAll('.location-group select, .location-group input[type="number"]');
                elements.forEach(element => {
                    element.removeEventListener('change', () => updateLocationField(formType));
                    element.removeEventListener('input', () => updateLocationField(formType));
                    
                    element.addEventListener('change', () => updateLocationField(formType));
                    element.addEventListener('input', () => updateLocationField(formType));
                });
                updateLocationField(formType);
            }
        }

        // **********************************************
        // 3. ìŠ¤ìºë„ˆ ë° ë°”ì½”ë“œ ìë™ ì™„ì„±
        // **********************************************

        function onScanSuccess(decodedText) {
            stopScanner();
            
            const activeForm = getActiveFormType();
            
            // 1. ë°”ì½”ë“œ í•„ë“œì— ê°’ ê¸°ì…
            document.getElementById('barcode').value = decodedText;
            document.getElementById('p_barcode').value = decodedText;
            document.getElementById('u_barcode').value = decodedText;
            
            // 2. ìƒí’ˆ ì •ë³´ ìë™ ì™„ì„± ì‹œë„
            fetchProductInfo(decodedText, activeForm); 
            
            // 3. í¬ì»¤ìŠ¤ ì´ë™
            if (activeForm === 'inbound') document.getElementById('itemName').focus();
            else if (activeForm === 'outbound') document.getElementById('p_batchNo').focus();
            else if (activeForm === 'update') document.getElementById('u_batchNo').focus();
        }
        
        function startScanner() {
            stopScanner(); 
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess,
                (errorMessage) => { /* ìŠ¤ìº” ì—ëŸ¬ ë¬´ì‹œ */ }
            ).catch((err) => {
                alert(`ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: ${err}. HTTPS í™˜ê²½ì„ í™•ì¸í•˜ì„¸ìš”.`);
            });
            document.getElementById('reader').style.display = 'block';
            document.getElementById('reader').scrollIntoView({ behavior: 'smooth' });
        }
        
        function stopScanner() {
            if (html5QrcodeScanner && html5QrcodeScanner.isScanning) { 
                html5QrcodeScanner.stop().then(() => {
                    document.getElementById('reader').style.display = 'none';
                    html5QrcodeScanner = null;
                }).catch((err) => {
                    console.error("Failed to stop scanning.", err);
                });
            } else if (html5QrcodeScanner) {
                 document.getElementById('reader').style.display = 'none';
                 html5QrcodeScanner = null;
            }
        }

        /** â­ï¸ ìƒí’ˆ ì •ë³´ë¥¼ GASë¡œë¶€í„° ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (google.script.run ë°©ì‹) â­ï¸ */
        function fetchProductInfo(barcode, formType) {
            // ë©”ì‹œì§€ ì´ˆê¸°í™”
            document.getElementById('statusMessage').innerHTML = '';
            document.getElementById('pickingStatusMessage').innerHTML = '';
            document.getElementById('updateStatusMessage').innerHTML = '';

            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            const updateFields = () => {
                document.getElementById('p_itemName').value = 'ì¡°íšŒ ì¤‘...';
                document.getElementById('p_itemCode').value = 'ì¡°íšŒ ì¤‘...';
                document.getElementById('u_itemName').value = 'ì¡°íšŒ ì¤‘...';
                document.getElementById('u_itemCode').value = 'ì¡°íšŒ ì¤‘...';
                if (formType === 'inbound') {
                    document.getElementById('itemName').value = 'ì¡°íšŒ ì¤‘...';
                    document.getElementById('itemCode').value = 'ì¡°íšŒ ì¤‘...';
                }
            };
            updateFields();

            // ì„±ê³µ ì½œë°±
            const onSuccess = (result) => {
                if (result.success && result.item) {
                    const itemName = result.item.itemName;
                    const itemCode = result.item.itemCode;

                    // ì…ê³  í¼: ê¸°ì¡´ ê°’ì´ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìœ¼ë©´ ìë™ ê¸°ì… 
                    if (formType === 'inbound') {
                        if (document.getElementById('itemName').value === 'ì¡°íšŒ ì¤‘...') document.getElementById('itemName').value = itemName;
                        if (document.getElementById('itemCode').value === 'ì¡°íšŒ ì¤‘...') document.getElementById('itemCode').value = itemCode;
                    } 
                    
                    // ì¶œê³ /ìˆ˜ì • í¼: ë¬´ì¡°ê±´ ìë™ ê¸°ì… 
                    document.getElementById('p_itemName').value = itemName;
                    document.getElementById('p_itemCode').value = itemCode;
                    document.getElementById('u_itemName').value = itemName;
                    document.getElementById('u_itemCode').value = itemCode;
                } else {
                    // ìƒí’ˆ ì •ë³´ ì—†ìŒ
                    if (formType === 'inbound') {
                        document.getElementById('itemName').value = '';
                        document.getElementById('itemCode').value = '';
                        alert(`âš ï¸ ${barcode}ì˜ ìƒí’ˆ ì •ë³´ê°€ ë§ˆìŠ¤í„°ì— ì—†ìŠµë‹ˆë‹¤. ì…ê³  ì‹œ ìƒí’ˆëª…/ìƒí’ˆì½”ë“œë¥¼ ì…ë ¥í•˜ë©´ ì‹ ê·œ ë“±ë¡ë©ë‹ˆë‹¤.`);
                    } else {
                        document.getElementById('p_itemName').value = 'N/A';
                        document.getElementById('p_itemCode').value = 'N/A';
                        document.getElementById('u_itemName').value = 'N/A';
                        document.getElementById('u_itemCode').value = 'N/A';
                        alert(`âš ï¸ ${barcode}ì˜ ì¬ê³  ì •ë³´ê°€ ë§ˆìŠ¤í„°ì— ì—†ìŠµë‹ˆë‹¤. (ì¡°íšŒ ë©”ì‹œì§€: ${result.message})`);
                    }
                }
            };

            // ì‹¤íŒ¨ ì½œë°± (í†µì‹  ì˜¤ë¥˜ ë° GAS ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì˜¤ë¥˜)
            const onFailure = (error) => {
                console.error('ìƒí’ˆ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
                alert(`ğŸ”´ google.script.run í†µì‹  ì˜¤ë¥˜ ë°œìƒ. (ë©”ì‹œì§€: ${error})`);
                
                // ì˜¤ë¥˜ ì‹œ í•„ë“œ N/A ì²˜ë¦¬
                document.getElementById('p_itemName').value = 'Error';
                document.getElementById('p_itemCode').value = 'Error';
                document.getElementById('u_itemName').value = 'Error';
                document.getElementById('u_itemCode').value = 'Error';
                if (formType === 'inbound') {
                    document.getElementById('itemName').value = 'Error';
                    document.getElementById('itemCode').value = 'Error';
                }
            };

            // GAS í•¨ìˆ˜ ì‹¤í–‰
            google.script.run
                .withSuccessHandler(onSuccess)
                .withFailureHandler(onFailure)
                .findProductInfoGAS(barcode);
        }

        
        function getActiveFormType() {
             if (document.getElementById('tabInbound').classList.contains('active')) return 'inbound';
             if (document.getElementById('tabOutbound').classList.contains('active')) return 'outbound';
             if (document.getElementById('tabUpdate').classList.contains('active')) return 'update';
             return '';
        }

        // **********************************************
        // 4. ë™ì  í¼ ì „í™˜ (ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€)
        // **********************************************

        function switchForm(type) {
            const forms = {
                'inbound': document.getElementById('inboundFormContainer'),
                'outbound': document.getElementById('outboundFormContainer'),
                'update': document.getElementById('stockUpdateFormContainer')
            };
            const tabs = {
                'inbound': document.getElementById('tabInbound'),
                'outbound': document.getElementById('tabOutbound'),
                'update': document.getElementById('tabUpdate')
            };

            for (let key in forms) {
                forms[key].style.display = (key === type) ? 'block' : 'none';
                if (key === type) {
                    tabs[key].classList.add('active');
                    attachLocationListeners(key);
                } else {
                    tabs[key].classList.remove('active');
                }
            }
            // ë©”ì‹œì§€ ì´ˆê¸°í™”
            statusMessage.innerHTML = '';
            pickingStatusMessage.innerHTML = '';
            updateStatusMessage.innerHTML = '';
        }

        // **********************************************
        // 5. API í†µì‹  ë° í¼ ì œì¶œ (POST) - fetch ì‚¬ìš© (doPost)
        // **********************************************

        /** API í˜¸ì¶œ ê³µí†µ í•¨ìˆ˜ (POST ìš”ì²­ì€ fetch ìœ ì§€) */
        async function sendDataToGAS(data, statusElement) {
            statusElement.innerHTML = 'ì²˜ë¦¬ ì¤‘...';
            statusElement.className = '';
            
            try {
                // â­ï¸ POST ìš”ì²­ì€ fetchë¥¼ ì‚¬ìš©í•˜ë©°, URLì€ ì¬ë°°í¬ëœ ì›¹ ì•±ì˜ URLì´ì–´ì•¼ í•©ë‹ˆë‹¤. â­ï¸
                if (GAS_API_URL === 'YOUR_GAS_API_URL_HERE') {
                    throw new Error('GAS API URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. POST ìš”ì²­ì„ ìœ„í•´ URLì„ í™•ì¸í•˜ì„¸ìš”.');
                }

                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(data)
                });
                
                const responseText = await response.text();
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    console.error('GAS POST ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨:', responseText);
                    statusElement.innerHTML = `ERROR: ì„œë²„ ì‘ë‹µì„ í•´ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. GAS ìŠ¤í¬ë¦½íŠ¸ ì˜¤ë¥˜(${response.status}).`;
                    statusElement.className = 'error';
                    return false;
                }

                if (result.success) {
                    statusElement.innerHTML = `SUCCESS: ${result.message}`;
                    statusElement.className = 'success';
                    return true;
                } else {
                    statusElement.innerHTML = `ERROR: ${result.message}`;
                    statusElement.className = 'error';
                    return false;
                }
            } catch (error) {
                statusElement.innerHTML = `í†µì‹  ì‹¤íŒ¨: ì„œë²„ ì—°ê²° ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜. (ë©”ì‹œì§€: ${error.message})`;
                statusElement.className = 'error';
                return false;
            }
        }

        // --- í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ê¸°ì¡´ê³¼ ë™ì¼í•˜ê²Œ ìœ ì§€) ---
        const locationForm = document.getElementById('locationForm');
        locationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!document.getElementById('fullLocation').value || 
                !document.getElementById('barcode').value.trim() ||
                !document.getElementById('itemName').value.trim() ||
                !document.getElementById('itemCode').value.trim() ||
                !document.getElementById('batchNo').value.trim() ||
                !document.getElementById('quantity').value || 
                parseInt(document.getElementById('quantity').value, 10) <= 0) 
            {
                alert('ğŸš¨ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì„ ëª¨ë‘ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\n(ë¡œì¼€ì´ì…˜, ë°”ì½”ë“œ, ìƒí’ˆëª…, ìƒí’ˆì½”ë“œ, ë°°ì¹˜ë²ˆí˜¸, ìˆ˜ëŸ‰)');
                return;
            }

            const fullLocationValue = document.getElementById('fullLocation').value.trim();
            const fullLocationParts = fullLocationValue.split('-'); 
            
            const rackType = fullLocationParts[0]; 
            const locationCode = fullLocationParts.slice(1).join('-'); 

            const data = {
                barcode: document.getElementById('barcode').value.trim(),
                batchNo: document.getElementById('batchNo').value.trim(),
                rackType: rackType,
                location: locationCode, 
                quantity: parseInt(document.getElementById('quantity').value, 10),
                itemName: document.getElementById('itemName').value.trim(),
                itemCode: document.getElementById('itemCode').value.trim(),
                action: "IN_LOC"
            };
            
            const success = await sendDataToGAS(data, statusMessage);
            if (success) {
                locationForm.reset();
                document.getElementById('quantity').value = '1';
                updateLocationField('inbound'); 
                document.getElementById('barcode').focus();
            }
        });

        const pickingForm = document.getElementById('pickingForm');
        pickingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!document.getElementById('p_fullLocation').value || 
                !document.getElementById('p_barcode').value.trim() ||
                !document.getElementById('p_batchNo').value.trim() ||
                !document.getElementById('p_quantity').value || 
                parseInt(document.getElementById('p_quantity').value, 10) <= 0) 
            {
                alert('ğŸš¨ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì„ ëª¨ë‘ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\n(ë¡œì¼€ì´ì…˜, ë°”ì½”ë“œ, ë°°ì¹˜ë²ˆí˜¸, ìˆ˜ëŸ‰)');
                return;
            }

            const qtyToSubtract = parseInt(document.getElementById('p_quantity').value, 10) * -1;

            const fullLocationValue = document.getElementById('p_fullLocation').value.trim();
            const fullLocationParts = fullLocationValue.split('-'); 
            
            const rackType = fullLocationParts[0]; 
            const locationCode = fullLocationParts.slice(1).join('-');
            
            const data = {
                barcode: document.getElementById('p_barcode').value.trim(),
                batchNo: document.getElementById('p_batchNo').value.trim(),
                rackType: rackType,
                location: locationCode, 
                quantity: qtyToSubtract, 
                itemName: document.getElementById('p_itemName').value.trim(),
                itemCode: document.getElementById('p_itemCode').value.trim(),
                action: "OUT_PICK"
            };

            const success = await sendDataToGAS(data, pickingStatusMessage);
            if (success) {
                pickingForm.reset();
                document.getElementById('p_quantity').value = '1';
                updateLocationField('outbound'); 
                document.getElementById('p_barcode').focus();
            }
        });
        
        const stockUpdateForm = document.getElementById('stockUpdateForm');
        stockUpdateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!document.getElementById('u_fullLocation').value || 
                !document.getElementById('u_barcode').value.trim() ||
                !document.getElementById('u_batchNo').value.trim() ||
                document.getElementById('u_currentQuantity').value === undefined || 
                parseInt(document.getElementById('u_currentQuantity').value, 10) < 0) 
            {
                alert('ğŸš¨ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì„ ëª¨ë‘ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.\n(ë¡œì¼€ì´ì…˜, ë°”ì½”ë“œ, ë°°ì¹˜ë²ˆí˜¸, ìµœì¢… ì‹¤ì‚¬ ìˆ˜ëŸ‰ì€ 0 ì´ìƒ)');
                return;
            }
            
            const fullLocationValue = document.getElementById('u_fullLocation').value.trim();
            const fullLocationParts = fullLocationValue.split('-'); 
            
            const rackType = fullLocationParts[0]; 
            const locationCode = fullLocationParts.slice(1).join('-');
            
            const data = {
                barcode: document.getElementById('u_barcode').value.trim(),
                batchNo: document.getElementById('u_batchNo').value.trim(),
                rackType: rackType,
                location: locationCode, 
                currentQuantity: document.getElementById('u_currentQuantity').value, 
                itemName: document.getElementById('u_itemName').value.trim(),
                itemCode: document.getElementById('u_itemCode').value.trim(),
                action: "UPDATE_STOCK" 
            };
            
            const success = await sendDataToGAS(data, updateStatusMessage);
            if (success) {
                stockUpdateForm.reset();
                document.getElementById('u_currentQuantity').value = '0';
                updateLocationField('update'); 
                document.getElementById('u_barcode').focus();
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            switchForm('inbound');
        });
    </script>
</body>
</html>
