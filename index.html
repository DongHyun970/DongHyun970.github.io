<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ ì¬ê³  ë¡œì¼€ì´ì…˜</title>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #28a745;
            --danger-color: #dc3545;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #343a40;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        body { 
            font-family: 'Roboto', sans-serif; 
            padding: 0; 
            margin: 0; 
            background-color: var(--background-color); 
            color: var(--text-color);
        }
        .container { 
            max-width: 600px; 
            margin: 0 auto; 
            padding: 20px;
        }
        h1 { 
            font-size: 24px; 
            text-align: center; 
            color: var(--primary-color); 
            margin-bottom: 20px;
        }
        h2 {
            font-size: 18px;
            color: var(--text-color);
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 5px;
            margin-top: 20px;
        }
        /* íƒ­ ìŠ¤íƒ€ì¼ */
        .tab-controls {
            display: flex;
            margin-bottom: 20px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }
        .tab-controls button {
            flex-grow: 1;
            padding: 15px;
            border: none;
            background-color: #e9ecef;
            color: var(--text-color);
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .tab-controls button.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        /* ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card {
            background-color: var(--card-background);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        /* í¼ ìš”ì†Œ */
        input:not([type="radio"]), select, button[type="submit"] { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 12px; 
            box-sizing: border-box; 
            border: 1px solid #ced4da; 
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        .action-button { 
            background-color: var(--secondary-color); 
            color: white; 
        }
        .action-button:hover { 
            background-color: #1e7e34; 
        }
        #pickingForm .action-button { 
            background-color: var(--danger-color); 
        }
        #pickingForm .action-button:hover { 
            background-color: #bd2130; 
        }
        /* ë¡œì¼€ì´ì…˜ ì…ë ¥ ê·¸ë£¹ */
        .location-group {
            display: flex;
            gap: 5px;
            margin-bottom: 12px;
        }
        .location-group input, .location-group select {
            flex: 1;
            text-align: center;
        }
        /* ìŠ¤ìºë„ˆ ì»¨íŠ¸ë¡¤ */
        .scanner-controls { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 20px; 
        }
        .scanner-controls button {
            flex: 1;
            padding: 10px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 4px;
        }
        .scanner-controls button:hover {
            background-color: #0056b3;
        }
        #reader { 
            width: 100%; 
            max-width: 400px; 
            margin: 15px auto; 
            border: 1px solid #ccc; 
            border-radius: 8px;
            overflow: hidden;
        }
        /* ë©”ì‹œì§€ */
        .success { color: #155724; background-color: #d4edda; border: 1px solid #c3e6cb; padding: 10px; border-radius: 4px; margin-top: 15px; }
        .error { color: #721c24; background-color: #f8d7da; border: 1px solid #f5c6cb; padding: 10px; border-radius: 4px; margin-top: 15px; }

        /* ë¹„í™œì„±í™” í•„ë“œ */
        input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>ìŠ¤ë§ˆíŠ¸ ì¬ê³  ë¡œì¼€ì´ì…˜ ì‹œìŠ¤í…œ</h1>

        <div class="tab-controls">
            <button id="tabInbound" onclick="switchForm('inbound')" class="active">â¬†ï¸ ì…ê³ </button>
            <button id="tabOutbound" onclick="switchForm('outbound')">â¬‡ï¸ ì¶œê³ </button>
        </div>

        <div id="scannerSection" class="card">
            <h2>ìŠ¤ìºë„ˆ ì»¨íŠ¸ë¡¤</h2>
            <div class="scanner-controls">
                <button onclick="startScanner('barcode')">ìƒí’ˆ ë°”ì½”ë“œ ìŠ¤ìº”</button>
                <button onclick="startScanner('location')">ë¡œì¼€ì´ì…˜ ìŠ¤ìº”</button>
                <button onclick="stopScanner()">ìŠ¤ìºë„ˆ ë„ê¸°</button>
            </div>
            <div id="reader"></div>
        </div>

        <div id="inboundFormContainer" class="card">
            <h2>ì…ê³  ì •ë³´</h2>
            <form id="locationForm">
                
                <div class="form-group">
                    <label>ë™ ë¡œì¼€ì´ì…˜ (A-1-1-1):</label>
                    <div class="location-group">
                        <select id="rackType" required onchange="updateLocationField()">
                            <option value="">ë™</option>
                            <option value="A">A</option>
                            <option value="B">B</option>
                            <option value="C">C</option>
                        </select>
                        <input type="number" id="rackCol" placeholder="ì—´" required min="1" oninput="updateLocationField()">
                        <input type="number" id="rackFloor" placeholder="ì¸µ" required min="1" oninput="updateLocationField()">
                        <select id="rackSide" required onchange="updateLocationField()">
                            <option value="">ì¢Œ/ìš°</option>
                            <option value="1">1 (ì¢Œ)</option>
                            <option value="2">2 (ìš°)</option>
                        </select>
                    </div>
                    <input type="text" id="location" placeholder="A-1-1-1 í˜•ì‹ìœ¼ë¡œ ìë™ ì…ë ¥ë©ë‹ˆë‹¤" required readonly>
                </div>

                <div class="form-group">
                    <label for="barcode">ìƒí’ˆ ë°”ì½”ë“œ:</label>
                    <input type="text" id="barcode" placeholder="ìŠ¤ìº” ë˜ëŠ” ì…ë ¥" required>
                </div>
                
                <div class="form-group">
                    <label for="itemName">ìƒí’ˆëª… / ì•„ì´í…œ ì½”ë“œ:</label>
                    <input type="text" id="itemName" placeholder="ìë™ ê¸°ì… / ì‹ ê·œ ë“±ë¡ ì‹œ ì…ë ¥" required>
                </div>

                <div class="form-group">
                    <label for="batchNo">ë°°ì¹˜ë²ˆí˜¸:</label>
                    <input type="text" id="batchNo" placeholder="ë°°ì¹˜ë²ˆí˜¸ ì…ë ¥/ìŠ¤ìº”" required>
                </div>
                
                <div class="form-group">
                    <label for="quantity">ìˆ˜ëŸ‰ (ì…ê³ ):</label>
                    <input type="number" id="quantity" value="1" min="1" required>
                </div>

                <button type="submit" class="action-button">âœ… ë¡œì¼€ì´ì…˜ ì§€ì • ë° ì…ê³ </button>
            </form>
            <div id="statusMessage"></div>
        </div>

        <div id="outboundFormContainer" class="card" style="display:none;">
            <h2>ì¶œê³  ì •ë³´</h2>
            <form id="pickingForm">
                <div class="form-group">
                    <label for="p_barcode">ì¶œê³  ìƒí’ˆ ë°”ì½”ë“œ:</label>
                    <input type="text" id="p_barcode" placeholder="ìŠ¤ìº” ë˜ëŠ” ì…ë ¥" required>
                </div>
                
                <div class="form-group">
                    <label for="p_itemName">ìƒí’ˆëª… / ì•„ì´í…œ ì½”ë“œ:</label>
                    <input type="text" id="p_itemName" placeholder="ìë™ ê¸°ì…" readonly>
                </div>
                
                <div class="form-group">
                    <label for="p_batchNo">ì¶œê³  ë°°ì¹˜ë²ˆí˜¸:</label>
                    <input type="text" id="p_batchNo" placeholder="ì¶œê³  ë°°ì¹˜ë²ˆí˜¸" required>
                </div>
                
                <div class="form-group">
                    <label for="p_location">ì¶œê³  ë¡œì¼€ì´ì…˜:</label>
                    <input type="text" id="p_location" placeholder="ì¶œê³  ë¡œì¼€ì´ì…˜ (ìŠ¤ìº” ë˜ëŠ” ì…ë ¥)" required>
                </div>
                
                <div class="form-group">
                    <label for="p_quantity">ìˆ˜ëŸ‰ (ì¶œê³ ):</label>
                    <input type="number" id="p_quantity" value="1" min="1" required>
                </div>

                <button type="submit" class="action-button">ğŸ”´ ì¬ê³  ì¶œê³  ì²˜ë¦¬</button>
            </form>
            <div id="pickingStatusMessage"></div>
        </div>

    </div>

    <script>
        // ğŸš¨ ì¤‘ìš”: ì—¬ê¸°ì— GAS ì›¹ ì•± URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”.
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbwuFyT0JHh6KqSUHVaQ07JRzQVvy5BYjXrEk-PdsXYqdIiQid_LTl73tiUc9hAX88FH-Q/exec'; 
        
        // **********************************************
        // 1. ìƒíƒœ ë³€ìˆ˜ ë° ìœ í‹¸ë¦¬í‹°
        // **********************************************

        let html5QrcodeScanner;
        let currentScanTarget = ''; // 'barcode' ë˜ëŠ” 'location'

        const statusMessage = document.getElementById('statusMessage');
        const pickingStatusMessage = document.getElementById('pickingStatusMessage');

        // **********************************************
        // 2. ë¡œì¼€ì´ì…˜ í•„ë“œ ê´€ë¦¬
        // **********************************************

        /** ë¡œì¼€ì´ì…˜ ê·¸ë£¹ í•„ë“œ ê°’ë“¤ì„ í•©ì³ ìµœì¢… ë¡œì¼€ì´ì…˜ í•„ë“œì— ë°˜ì˜í•©ë‹ˆë‹¤. */
        function updateLocationField() {
            const rackType = document.getElementById('rackType').value;
            const rackCol = document.getElementById('rackCol').value;
            const rackFloor = document.getElementById('rackFloor').value;
            const rackSide = document.getElementById('rackSide').value;
            
            const locationField = document.getElementById('location');

            if (rackType && rackCol && rackFloor && rackSide) {
                locationField.value = `${rackType}-${rackCol}-${rackFloor}-${rackSide}`;
            } else {
                locationField.value = ''; // í•„ìˆ˜ê°€ ì•„ë‹Œ ê²½ìš° ë¹„ì›Œë‘ 
            }
        }

        // **********************************************
        // 3. ìŠ¤ìºë„ˆ ë° ë°”ì½”ë“œ ìë™ ì™„ì„±
        // **********************************************

        /** ë°”ì½”ë“œ ìŠ¤ìº” ì„±ê³µ ì‹œ í˜¸ì¶œë©ë‹ˆë‹¤. */
        function onScanSuccess(decodedText) {
            stopScanner();
            
            if (currentScanTarget === 'barcode') {
                document.getElementById('barcode').value = decodedText;
                document.getElementById('p_barcode').value = decodedText;
                
                // ë°”ì½”ë“œ ìŠ¤ìº” í›„ ìƒí’ˆ ì •ë³´ ìë™ ì™„ì„± ì‹œë„
                fetchProductInfo(decodedText); 
                
                // í˜„ì¬ í™œì„±í™”ëœ í¼ì— ë”°ë¼ í¬ì»¤ìŠ¤ ì´ë™
                const activeForm = document.getElementById('tabInbound').classList.contains('active') ? 'inbound' : 'outbound';
                if (activeForm === 'inbound') {
                    document.getElementById('batchNo').focus();
                } else {
                    document.getElementById('p_batchNo').focus();
                }

            } else if (currentScanTarget === 'location') {
                // ë¡œì¼€ì´ì…˜ ìŠ¤ìº” ì‹œ ë¡œì¼€ì´ì…˜ ê·¸ë£¹ í•„ë“œ ì±„ìš°ê¸° (ë¡œì¼€ì´ì…˜ í•„ë“œëŠ” ì…ê³  í¼ì—ë§Œ í•„ìš”)
                document.getElementById('p_location').value = decodedText;
                
                // ë¡œì¼€ì´ì…˜ ì½”ë“œë¥¼ ë¶„ë¦¬í•˜ì—¬ ì…ê³  í¼ í•„ë“œ ì±„ìš°ê¸° (A-1-1-1 í˜•ì‹ ê°€ì •)
                const parts = decodedText.split('-');
                if(parts.length === 4) {
                    document.getElementById('rackType').value = parts[0];
                    document.getElementById('rackCol').value = parts[1];
                    document.getElementById('rackFloor').value = parts[2];
                    document.getElementById('rackSide').value = parts[3];
                    updateLocationField(); // ìµœì¢… í•„ë“œ ì—…ë°ì´íŠ¸
                } else {
                    // ì¶œê³  í¼ì˜ ê²½ìš° p_locationë§Œ ì±„ì›€
                    document.getElementById('location').value = decodedText;
                }
                
                // ì…ê³  í¼ ê¸°ì¤€ìœ¼ë¡œ ë‹¤ìŒ í•„ë“œì¸ ìˆ˜ëŸ‰ìœ¼ë¡œ í¬ì»¤ìŠ¤ ì´ë™
                document.getElementById('quantity').focus(); 
            }
        }
        
        /** ìŠ¤ìºë„ˆ ì‹œì‘/ì •ì§€ ë¡œì§ (ì´ì „ ì½”ë“œ ìœ ì§€) */
        function startScanner(target) {
            currentScanTarget = target;
            stopScanner(); 
            html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start(
                { facingMode: "environment" }, 
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess,
                (errorMessage) => { /* ìŠ¤ìº” ì—ëŸ¬ ë¬´ì‹œ */ }
            ).catch((err) => {
                alert(`ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜: ${err}. HTTPS í™˜ê²½ì„ í™•ì¸í•˜ì„¸ìš”.`);
            });
            document.getElementById('reader').style.display = 'block';
            document.getElementById('reader').scrollIntoView({ behavior: 'smooth' });
        }
        
        function stopScanner() {
            if (html5QrcodeScanner && html5QrcodeScanner.isScanning) { 
                html5QrcodeScanner.stop().then(() => {
                    document.getElementById('reader').style.display = 'none';
                    html5QrcodeScanner = null;
                }).catch((err) => {
                    console.error("Failed to stop scanning.", err);
                });
            } else if (html5QrcodeScanner) {
                 document.getElementById('reader').style.display = 'none';
                 html5QrcodeScanner = null;
            }
        }

        /** ìƒí’ˆ ì •ë³´ë¥¼ GASë¡œë¶€í„° ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (GET ìš”ì²­ í•„ìš”) */
        async function fetchProductInfo(barcode) {
            // â­ ì´ ê¸°ëŠ¥ì€ GASì— doGet(e) í•¨ìˆ˜ë¥¼ í†µí•´ ë°”ì½”ë“œì— í•´ë‹¹í•˜ëŠ” ìƒí’ˆëª…ì„ ì¡°íšŒí•˜ëŠ”
            // API ë¡œì§ì´ ì¶”ê°€ë˜ì–´ì•¼ ë™ì‘í•©ë‹ˆë‹¤. (ì•„ë˜ 4ë‹¨ê³„ GAS ìˆ˜ì • í•„ìš”)
            try {
                // GET ìš”ì²­ìœ¼ë¡œ ìƒí’ˆ ì •ë³´ ì¡°íšŒ (GAS ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° ì‚¬ìš©)
                const url = `${GAS_API_URL}?action=GET_ITEM&barcode=${barcode}`;
                const response = await fetch(url);
                const result = await response.json();

                if (result.success && result.item) {
                    document.getElementById('itemName').value = result.item.itemName;
                    document.getElementById('p_itemName').value = result.item.itemName;
                } else {
                    // ìƒí’ˆ ì •ë³´ ì—†ìŒ -> ì‹ ê·œ ë“±ë¡ ìœ ë„
                    document.getElementById('itemName').value = 'NEW ITEM - Enter Name';
                    document.getElementById('p_itemName').value = 'NEW ITEM';
                    alert('ìƒí’ˆ ì •ë³´ê°€ ë§ˆìŠ¤í„°ì— ì—†ìŠµë‹ˆë‹¤. ì…ê³  ì‹œ ìƒí’ˆëª…ì„ ì…ë ¥í•˜ë©´ ì‹ ê·œ ë“±ë¡ë©ë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ìƒí’ˆ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
                // í†µì‹  ì˜¤ë¥˜ ë°œìƒ ì‹œ ìˆ˜ë™ ì…ë ¥ ìœ ë„
                document.getElementById('itemName').value = '';
                document.getElementById('p_itemName').value = '';
            }
        }

        // **********************************************
        // 4. ë™ì  í¼ ì „í™˜
        // **********************************************

        /** ì…ê³ /ì¶œê³  í¼ ì „í™˜ */
        function switchForm(type) {
            const inboundContainer = document.getElementById('inboundFormContainer');
            const outboundContainer = document.getElementById('outboundFormContainer');
            const tabInbound = document.getElementById('tabInbound');
            const tabOutbound = document.getElementById('tabOutbound');

            if (type === 'inbound') {
                inboundContainer.style.display = 'block';
                outboundContainer.style.display = 'none';
                tabInbound.classList.add('active');
                tabOutbound.classList.remove('active');
            } else {
                inboundContainer.style.display = 'none';
                outboundContainer.style.display = 'block';
                tabInbound.classList.remove('active');
                tabOutbound.classList.add('active');
            }
            // ë©”ì‹œì§€ ì´ˆê¸°í™”
            statusMessage.innerHTML = '';
            pickingStatusMessage.innerHTML = '';
        }

        // **********************************************
        // 5. API í†µì‹  ë° í¼ ì œì¶œ
        // **********************************************

        /** API í˜¸ì¶œ ê³µí†µ í•¨ìˆ˜ (ì´ì „ ì½”ë“œ ìœ ì§€) */
        async function sendDataToGAS(data, statusElement) {
            statusElement.innerHTML = 'ì²˜ë¦¬ ì¤‘...';
            statusElement.className = '';
            
            try {
                const response = await fetch(GAS_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();

                if (result.success) {
                    statusElement.innerHTML = `SUCCESS: ${result.message}`;
                    statusElement.className = 'success';
                    return true;
                } else {
                    statusElement.innerHTML = `ERROR: ${result.message}`;
                    statusElement.className = 'error';
                    return false;
                }
            } catch (error) {
                statusElement.innerHTML = `í†µì‹  ì‹¤íŒ¨: ì„œë²„ ì—°ê²° ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ (${error.message})`;
                statusElement.className = 'error';
                return false;
            }
        }

        // --- í¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        const locationForm = document.getElementById('locationForm');
        const pickingForm = document.getElementById('pickingForm');
        
        // 1. ì…ê³ /ì§€ì • í¼ ì œì¶œ
        locationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = {
                barcode: document.getElementById('barcode').value.trim(),
                batchNo: document.getElementById('batchNo').value.trim(),
                location: document.getElementById('location').value.trim(), // ìë™ ì™„ì„±ëœ ìµœì¢… ë¡œì¼€ì´ì…˜
                quantity: parseInt(document.getElementById('quantity').value, 10),
                itemName: document.getElementById('itemName').value.trim(), // ì‹ ê·œ ë“±ë¡ì„ ìœ„í•´ itemName ì „ì†¡
                action: "IN_LOC"
            };
            
            const success = await sendDataToGAS(data, statusMessage);
            if (success) {
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                locationForm.reset();
                document.getElementById('quantity').value = '1';
                document.getElementById('barcode').focus();
            }
        });

        // 2. ì¶œê³  í¼ ì œì¶œ
        pickingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const qtyToSubtract = parseInt(document.getElementById('p_quantity').value, 10) * -1; // ìŒìˆ˜ ìˆ˜ëŸ‰

            const data = {
                barcode: document.getElementById('p_barcode').value.trim(),
                batchNo: document.getElementById('p_batchNo').value.trim(),
                location: document.getElementById('p_location').value.trim(),
                quantity: qtyToSubtract, 
                itemName: document.getElementById('p_itemName').value.trim(), // í˜„ì¬ëŠ” ì‚¬ìš©ë˜ì§€ ì•Šìœ¼ë‚˜ êµ¬ì¡° ìœ ì§€ë¥¼ ìœ„í•´ ì „ì†¡
                action: "OUT_PICK"
            };

            const success = await sendDataToGAS(data, pickingStatusMessage);
            if (success) {
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                pickingForm.reset();
                document.getElementById('p_quantity').value = '1';
                document.getElementById('p_barcode').focus();
            }
        });

        // ì´ˆê¸° ë¡œë“œ ì‹œ ì…ê³  í¼ í™œì„±í™”
        document.addEventListener('DOMContentLoaded', () => {
            switchForm('inbound');
            // ë¡œì¼€ì´ì…˜ í•„ë“œ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
            document.querySelectorAll('#locationForm .location-group select, #locationForm .location-group input[type="number"]').forEach(element => {
                element.addEventListener('change', updateLocationField);
                element.addEventListener('input', updateLocationField);
            });
        });
    </script>
</body>
</html>

